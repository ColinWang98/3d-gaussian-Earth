<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Hub | Pro Holographic Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
    <style>
        :root { --primary: #00ff88; --danger: #ff4444; --glass: rgba(10, 15, 30, 0.95); --accent: #0072ff; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map-background { position: absolute; inset: 0; z-index: 1; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }
        #app-title { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); color: white; font-size: 28px; font-weight: 300; letter-spacing: 2px; z-index: 1001; pointer-events: none; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        #lang-toggle { position: absolute; top: 20px; left: 20px; background: var(--glass); color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 20px; cursor: pointer; z-index: 1001; }
        #map-style-toggle { position: absolute; top: 20px; left: 90px; background: var(--glass); color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 20px; cursor: pointer; z-index: 1001; font-size: 0.9em; }
        #upload-btn { position: absolute; top: 20px; right: 20px; background: var(--accent); border: none; padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; z-index: 1001; }
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: white; display: none; }
        #splat-viewer { position: absolute; inset: 0; background: transparent; z-index: 9999; display: none; }
        /* ç¡®ä¿ splat-viewer æœ¬èº«ä¸é˜»æŒ¡é¼ æ ‡äº‹ä»¶ï¼Œåªæœ‰å­å…ƒç´ å¯ä»¥äº¤äº’
           å…è®¸è¿”å›æŒ‰é’®å’ŒèŠå¤©çª—å£æ¥æ”¶é¼ æ ‡äº‹ä»¶ */
        #splat-viewer > *:not(canvas):not(#close-splat):not(#chat-window) { pointer-events: none; }
        #close-splat { position: absolute; top: 20px; left: 20px; z-index: 2100; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer; pointer-events: auto; }
        /* ä¸ºäº†ç¡®ä¿ 3D ç”»å¸ƒå¯äº¤äº’ï¼ŒèŠå¤©çª—å£ä¸æ‹¦æˆªé¼ æ ‡äº‹ä»¶ */
        #chat-window { position: absolute; bottom: 20px; right: 20px; width: 320px; height: 400px; background: var(--glass); border-radius: 15px; border: 1px solid #333; display: none; flex-direction: column; z-index: 2100; box-shadow: 0 12px 40px rgba(0,0,0,0.6); overflow: hidden; }
        #chat-msgs { flex: 1; padding: 12px; overflow-y: auto; font-size: 0.85em; color: #eee; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 85%; }
        .msg-agent { background: var(--accent); align-self: flex-start; }
        .msg-user { background: #333; align-self: flex-end; }
        #chat-input-wrap { display: flex; border-top: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3); }
        #chat-input { flex: 1; background: transparent; border: none; color: white; outline: none; }
        #modal-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 3000; pointer-events: auto; }
        .modal-box { background: #151525; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; color: white; border: 1px solid #333; }
        input, textarea { width: 100%; box-sizing: border-box; background: #050510; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; margin: 10px 0; }
        /* åŠ è½½æç¤ºï¼šæ”¹ä¸ºå³ä¸Šè§’å°å¾½æ ‡ï¼Œè€Œä¸æ˜¯å…¨å±é®ç½©ï¼Œä¸”ä¸æ‹¦æˆªäº¤äº’ */
        #loading-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            min-width: 160px;
            padding: 6px 14px;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 12px;
            z-index: 2100;
            pointer-events: none;
        }
        /* ç¡®ä¿æ‰€æœ‰ canvas éƒ½å¯ä»¥äº¤äº’ï¼Œä¸»æ¸²æŸ“ canvas åœ¨æœ€ä¸Šå±‚ */
        #splat-viewer canvas { pointer-events: auto !important; position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important; z-index: 100 !important; }
    </style>
    <script type="importmap">{ "imports": { 
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "@huggingface/hub": "https://cdn.jsdelivr.net/npm/@huggingface/hub@0.15.1/+esm"
    }}</script>
</head>
<body>
    <div id="map-background"></div>
    <div id="splat-viewer" class="pointer-auto">
        <div id="loading-overlay"></div>
        <button id="close-splat">â† è¿”å›åœ°å›¾</button>
        <div id="chat-window">
            <div id="gemini-config-ui" style="padding:20px; text-align:center;">
                <p style="color:var(--primary); font-size:0.9em;">ğŸ‘¤ æ¿€æ´» AI å¯¼è§ˆå‘˜</p>
                <input type="password" id="user-gemini-key" placeholder="Gemini API Key...">
                <button id="save-key-btn" style="background:var(--accent); color:white; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer;">å¼€å¯ AI å¯¹è¯</button>
            </div>
            <div id="chat-main-ui" style="display:none; flex-direction:column; height:100%;">
                <div id="chat-msgs"></div>
                <div id="chat-input-wrap">
                    <input type="text" id="chat-input" placeholder="æé—®...">
                    <button id="chat-send" style="background:none; border:none; color:var(--primary); cursor:pointer;">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ui-layer">
        <h1 id="app-title">Spatial Memory Map</h1>
        <button id="lang-toggle" class="pointer-auto">EN / ä¸­</button>
        <button id="map-style-toggle" class="pointer-auto">ğŸ—ºï¸ åœ°å›¾æ ·å¼</button>
        <button id="upload-btn" class="pointer-auto">+ æ–°å¢ä»»åŠ¡</button>
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title" style="margin:0"></h3>
            <p id="loc-desc" style="color:#aaa; font-size:0.85em; margin:10px 0;"></p>
            <div style="display:flex; justify-content:space-between; gap:10px;">
                <button id="del-btn" style="background:var(--danger); border:none; padding:8px 15px; border-radius:10px; color:white; cursor:pointer; font-weight:bold;">åˆ é™¤</button>
                <button id="enter-btn" style="background:var(--primary); border:none; padding:10px 25px; border-radius:20px; cursor:pointer; font-weight:bold; color:#000;">å…¨æ¯æŸ¥çœ‹</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-box">
            <h3 style="margin:0 0 15px 0">åˆ›å»ºé‡å»ºä»»åŠ¡</h3>
            <input type="password" id="hf-token" placeholder="Hugging Face Write Token">
            <input type="password" id="deepl-key" placeholder="DeepL API Key (å¯é€‰ï¼Œç”¨äºè‡ªåŠ¨ç¿»è¯‘)">
            <input type="text" id="loc-name" placeholder="åœ°ç‚¹åç§° (ä¸­æ–‡)">
            <input type="text" id="loc-name-en" placeholder="Location Name (Englishï¼Œç•™ç©ºå°†è‡ªåŠ¨ç¿»è¯‘)">
            <div style="display:flex; gap:8px;">
                <input type="text" id="lat-lon" readonly placeholder="ç‚¹å‡»åœ°å›¾æ‹¾å–åæ ‡">
                <button id="pick-btn" style="background:var(--accent); border:none; padding:0 15px; border-radius:8px; color:white; cursor:pointer;">æ‹¾å–</button>
            </div>
            <input type="file" id="photo-input" accept="image/*">
            <textarea id="desc-input" rows="2" placeholder="è¯·è¾“å…¥æè¿° (ä¸­æ–‡ï¼Œå°†è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡)..."></textarea>
            <button id="submit-btn" style="width:100%; background:var(--primary); border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:10px;">ä¸Šä¼ ä»»åŠ¡</button>
            <button onclick="document.getElementById('modal-overlay').style.display='none'" style="width:100%; background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <script type="module">
        import { commit } from '@huggingface/hub';
        import * as THREE from 'three';
        import * as GaussianSplats3D from 'https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js';

        const REPO_ID = "ColinWong24/my-gaussian-world";
        const state = { locations: [], currentLoc: null, lang: 'cn', viewer: null, isPicking: false, selectedCoords: null, deeplKey: localStorage.getItem('DEEPL_KEY') || '' };
        let ACTIVE_GEMINI_KEY = localStorage.getItem('MY_GEMINI_KEY') || '';
        
        // DeepL è‡ªåŠ¨ç¿»è¯‘å‡½æ•°
        async function translateWithDeepL(text, targetLang = 'EN') {
            if (!state.deeplKey || !text) return text;
            try {
                const res = await fetch('https://api-free.deepl.com/v2/translate', {
                    method: 'POST',
                    headers: {
                        'Authorization': `DeepL-Auth-Key ${state.deeplKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: [text],
                        target_lang: targetLang
                    })
                });
                if (!res.ok) throw new Error(`DeepL API é”™è¯¯: ${res.status}`);
                const data = await res.json();
                return data.translations[0].text;
            } catch (e) {
                console.warn('DeepL ç¿»è¯‘å¤±è´¥:', e);
                return text; // ç¿»è¯‘å¤±è´¥æ—¶è¿”å›åŸæ–‡
            }
        }

        function updateLangUI() {
            const langBtn = document.getElementById('lang-toggle');
            if (langBtn) langBtn.innerText = state.lang === 'cn' ? 'EN / ä¸­' : 'ä¸­ / EN';

            // æ ¹æ®è¯­è¨€åˆ‡æ¢å½“å‰åœ°ç‚¹æ ‡é¢˜å’Œæè¿°ï¼ˆå¦‚æœæœ‰è‹±æ–‡å­—æ®µï¼‰
            if (state.currentLoc) {
                const loc = state.currentLoc;
                const titleEl = document.getElementById('loc-title');
                const descEl = document.getElementById('loc-desc');
                if (state.lang === 'cn') {
                    titleEl.innerText = loc.name || '';
                    descEl.innerText = loc.desc || 'å¤„ç†ä¸­...';
                } else {
                    titleEl.innerText = loc.name_en || loc.name || '';
                    descEl.innerText = loc.desc_en || loc.desc || 'Processing...';
                }
            }

            // åŒæ­¥æ›´æ–°åœ°å›¾æ ·å¼æŒ‰é’®çš„æ–‡æ¡ˆ
            updateMapStyleButton();
        }

        // ===== AI èŠå¤©ç›¸å…³ =====
        function addChatMessage(role, text) {
            const msgs = document.getElementById('chat-msgs');
            if (!msgs) return;
            const div = document.createElement('div');
            div.className = `msg msg-${role}`;
            div.innerText = text;
            msgs.appendChild(div);
            msgs.scrollTop = msgs.scrollHeight;
        }

        function showChatUI() {
            const chatWin = document.getElementById('chat-window');
            if (!chatWin) return;
            chatWin.style.display = 'flex';

            const cfg = document.getElementById('gemini-config-ui');
            const main = document.getElementById('chat-main-ui');

            if (ACTIVE_GEMINI_KEY) {
                cfg.style.display = 'none';
                main.style.display = 'flex';
                // é¦–æ¬¡æ‰“å¼€å½“å‰åœ°ç‚¹æ—¶æ‰“ä¸ªæ‹›å‘¼
                if (document.getElementById('chat-msgs').children.length === 0 && state.currentLoc) {
                    const locName = state.currentLoc.name || state.currentLoc.name_en || 'è¿™ä¸ªåœ°æ–¹';
                    addChatMessage('agent', `ä½ å¥½ï¼Œæˆ‘æ˜¯è¿™ä¸ªåœºæ™¯çš„æ‹æ‘„è€…ï¼Œç°åœ¨å¸¦ä½ çœ‹ï¼š${locName}ã€‚å¯ä»¥éšä¾¿é—®æˆ‘é—®é¢˜ï½`);
                }
            } else {
                cfg.style.display = 'block';
                main.style.display = 'none';
            }
        }

        async function handleChat() {
            if (!ACTIVE_GEMINI_KEY) {
                alert('è¯·å…ˆåœ¨å³ä¸‹è§’è¾“å…¥ Gemini API Key');
                return;
            }
            const input = document.getElementById('chat-input');
            const text = (input.value || '').trim();
            if (!text) return;
            addChatMessage('user', text);
            input.value = '';

            const loc = state.currentLoc || {};
            const locName = loc.name_en || loc.name || '';
            const locDesc = loc.desc_en || loc.desc || '';
            const sys = `ä½ æ˜¯ 3D å…¨æ¯åœºæ™¯çš„æ‹æ‘„è€…ï¼Œä»¥ç¬¬ä¸€äººç§°ã€å£è¯­åŒ–ç®€çŸ­å›ç­”ç”¨æˆ·é—®é¢˜ï¼Œå¤šç”¨â€œå””â€ã€â€œå•Šâ€ã€â€œå…¶å®â€ç­‰å£å¤´è¯­ã€‚
åœ°ç‚¹: ${locName}
èƒŒæ™¯: ${locDesc}`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${ACTIVE_GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [
                            { role: 'user', parts: [{ text: sys }] },
                            { role: 'user', parts: [{ text }] }
                        ]
                    })
                });
                const data = await res.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || 'å””ï¼Œæˆ‘ä¸€æ—¶é—´æœ‰ç‚¹æƒ³ä¸åˆ°ï¼Œç­‰æˆ‘å†ç ”ç©¶ä¸‹å…ˆï½';
                addChatMessage('agent', reply);
            } catch (e) {
                console.error('Gemini è°ƒç”¨å¤±è´¥:', e);
                addChatMessage('agent', 'å””ï¼ŒAI é‚£è¾¹è¿ä¸ä¸Šç½‘ç»œäº†ï¼Œä¸€é˜µå†è¯•è¯•å•¦ã€‚');
            }
        }

        // 1. åˆå§‹åŒ–åœ°å›¾ [web:13]
        const map = L.map('map-background', { center: [22.3193, 114.1694], zoom: 13, zoomControl: false });
        
        // åœ°å›¾æ ·å¼é…ç½®
        const mapStyles = {
            dark: {
                nameCn: 'æ·±è‰²',
                nameEn: 'Dark',
                url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
            },
            light: {
                nameCn: 'æµ…è‰²',
                nameEn: 'Light',
                url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
            },
            satellite: {
                nameCn: 'å«æ˜Ÿ',
                nameEn: 'Satellite',
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
            },
            terrain: {
                nameCn: 'åœ°å½¢',
                nameEn: 'Terrain',
                url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'
            }
        };
        
        let currentMapStyle = 'dark';
        let currentTileLayer = L.tileLayer(mapStyles[currentMapStyle].url).addTo(map);
        const markerGroup = L.layerGroup().addTo(map);

        function updateMapStyleButton() {
            const btn = document.getElementById('map-style-toggle');
            if (!btn) return;
            const styleCfg = mapStyles[currentMapStyle];
            if (!styleCfg) return;
            const name = state.lang === 'cn' ? styleCfg.nameCn : styleCfg.nameEn;
            btn.innerText = `ğŸ—ºï¸ ${name}`;
        }
        
        // åœ°å›¾æ ·å¼åˆ‡æ¢åŠŸèƒ½
        document.getElementById('map-style-toggle').onclick = () => {
            const styles = Object.keys(mapStyles);
            const currentIndex = styles.indexOf(currentMapStyle);
            const nextIndex = (currentIndex + 1) % styles.length;
            currentMapStyle = styles[nextIndex];
            
            // ç§»é™¤æ—§å›¾å±‚
            map.removeLayer(currentTileLayer);
            
            // æ·»åŠ æ–°å›¾å±‚
            currentTileLayer = L.tileLayer(mapStyles[currentMapStyle].url).addTo(map);
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬ï¼ˆæ ¹æ®å½“å‰è¯­è¨€æ˜¾ç¤ºä¸­/è‹±æ–‡ï¼‰
            updateMapStyleButton();
        };

        // 2. æ•°æ®åŠ è½½ä¸åŒæ­¥ [web:18]
        async function loadLocations() {
            try {
                const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
                state.locations = await res.json();
                markerGroup.clearLayers();
                state.locations.forEach(loc => {
                    const ready = loc.status === 'ready';
                    L.circleMarker([loc.lat, loc.lon], { radius: 10, fillColor: ready ? '#00ff88' : '#ffcc00', fillOpacity: 0.8, color: '#fff', weight: 2 })
                    .addTo(markerGroup).on('click', () => {
                        state.currentLoc = loc;
                        state.currentLoc = loc;
                        // æ ¹æ®å½“å‰è¯­è¨€æ¸²æŸ“æ ‡é¢˜ä¸æè¿°
                        if (state.lang === 'cn') {
                            document.getElementById('loc-title').innerText = loc.name;
                            document.getElementById('loc-desc').innerText = loc.desc || "å¤„ç†ä¸­...";
                        } else {
                            document.getElementById('loc-title').innerText = loc.name_en || loc.name;
                            document.getElementById('loc-desc').innerText = loc.desc_en || loc.desc || "Processing...";
                        }
                        document.getElementById('info-bar').style.display = 'block';
                        document.getElementById('enter-btn').disabled = !ready;
                        document.getElementById('enter-btn').style.opacity = ready ? "1" : "0.5";
                    });
                });
            } catch(e) { console.error("åŠ è½½å¤±è´¥", e); }
        }

        // 3. æ ¸å¿ƒ 3D æ¸²æŸ“ä¿®å¤ + è¿›å…¥ 3D è§†å›¾æ—¶æ‰“å¼€ AI èŠå¤© [web:63][web:69][web:72]
        document.getElementById('enter-btn').onclick = async () => {
            const container = document.getElementById('splat-viewer');
            const loader = document.getElementById('loading-overlay');
            container.style.display = 'block';
            loader.style.display = 'flex';
            loader.innerText = 'ğŸš€ æ­£åœ¨åŠ è½½ 3D å…¨æ¯æ¨¡å‹...';

            // æ‰“å¼€ 3D è§†å›¾æ—¶éšè—åœ°å›¾å’Œä¸Šå±‚ UIï¼Œé¿å…æŒ¡ä½æ¨¡å‹äº¤äº’
            document.getElementById('ui-layer').style.display = 'none';
            document.getElementById('map-background').style.display = 'none';
            // ç¡®ä¿ä»»åŠ¡å¼¹çª—å…³é—­ï¼Œé¿å…ç°è‰²è’™å±‚æ®‹ç•™
            const modal = document.getElementById('modal-overlay');
            if (modal) modal.style.display = 'none';
            // æ˜¾ç¤ºèŠå¤©çª—å£ï¼ˆç”± showChatUI æ§åˆ¶å†…éƒ¨å†…å®¹ï¼‰
            showChatUI();

            if (state.viewer) { state.viewer.dispose(); state.viewer = null; }

            state.viewer = new GaussianSplats3D.Viewer({
                rootElement: container,
                cameraUp: [0, -1, 0],
                sharedMemoryForWorkers: false, // ç¦ç”¨å…±äº«å†…å­˜ä»¥é¿å¼€å®‰å…¨ç­–ç•¥
                webWorkerCount: 0,             // å¼ºåˆ¶å•çº¿ç¨‹è§£æï¼Œè§£å†³ postMessage æŠ¥é”™
                showSceneStatePlaceholder: false
            });

            await state.viewer.init();
            const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.currentLoc.splatPath}`;
            
            try {
            await state.viewer.addSplatScene(url, {
                'onSceneLoad': (scene) => {
                        // ç¡®ä¿åŠ è½½å±‚å®Œå…¨éšè—
                        loader.style.display = 'none';
                        loader.style.pointerEvents = 'none';
                        
                    const mesh = scene.object3D;
                    mesh.rotation.y = Math.PI;
                    const box = new THREE.Box3().setFromObject(mesh);
                        mesh.position.sub(box.getCenter(new THREE.Vector3())); // å±…ä¸­ [web:5]
                        
                        // è°ƒæ•´æ¸²æŸ“è®¾ç½®ï¼Œè®©ç”»é¢æ›´äº®
                        if (state.viewer.renderer) {
                            // è®¾ç½®æ›´äº®çš„èƒŒæ™¯è‰²
                            state.viewer.renderer.setClearColor(0x1a1a1a, 1);
                            // å¯ç”¨è‰²è°ƒæ˜ å°„ä»¥æé«˜äº®åº¦
                            state.viewer.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                            state.viewer.renderer.toneMappingExposure = 1.2; // å¢åŠ æ›å…‰åº¦
                        }
                        
                        // è°ƒæ•´ç›¸æœºæ›å…‰ï¼ˆå¦‚æœæ”¯æŒï¼‰
                        if (state.viewer.camera && state.viewer.camera.exposure !== undefined) {
                            state.viewer.camera.exposure = 1.2;
                        }
                        
                        // ç¡®ä¿ Viewer çš„æ¸²æŸ“ canvas åœ¨æœ€ä¸Šå±‚ï¼Œå…¶ä»–å…ƒç´ ä¸é˜»æŒ¡
                        setTimeout(() => {
                            const allCanvases = container.querySelectorAll('canvas');
                            console.log(`æ‰¾åˆ° ${allCanvases.length} ä¸ª canvas å…ƒç´ `);
                            
                            // æ‰¾åˆ°ä¸»è¦çš„æ¸²æŸ“ canvasï¼ˆé€šå¸¸æ˜¯æœ€å¤§çš„ï¼Œæˆ–è€…åŒ…å« 3D å†…å®¹çš„ï¼‰
                            let mainCanvas = null;
                            let maxArea = 0;
                            
                            allCanvases.forEach(canvas => {
                                const area = canvas.width * canvas.height;
                                if (area > maxArea) {
                                    maxArea = area;
                                    mainCanvas = canvas;
                                }
                            });
                            
                            if (mainCanvas) {
                                // è®¾ç½®ä¸»æ¸²æŸ“ canvas åœ¨æœ€ä¸Šå±‚ï¼Œä½¿ç”¨æœ€é«˜ä¼˜å…ˆçº§
                                mainCanvas.style.pointerEvents = 'auto';
                                mainCanvas.style.position = 'absolute';
                                mainCanvas.style.top = '0';
                                mainCanvas.style.left = '0';
                                mainCanvas.style.width = '100%';
                                mainCanvas.style.height = '100%';
                                mainCanvas.style.zIndex = '100';
                                mainCanvas.style.setProperty('z-index', '100', 'important');
                                console.log('âœ… ä¸»æ¸²æŸ“ Canvas å·²è®¾ç½®ä¸ºå¯äº¤äº’ï¼Œz-index: 100');
                                
                                // å…¶ä»– canvas è®¾ç½®ä¸ºä¸é˜»æŒ¡é¼ æ ‡äº‹ä»¶ï¼Œä½†ä¿æŒåœ¨è¾ƒä½å±‚çº§
                                allCanvases.forEach(canvas => {
                                    if (canvas !== mainCanvas) {
                                        canvas.style.pointerEvents = 'none';
                                        canvas.style.zIndex = '1';
                                        console.log('âš ï¸ å…¶ä»– Canvas å·²ç¦ç”¨é¼ æ ‡äº‹ä»¶');
                                    }
                                });
                                
                                // ç¡®ä¿ä¸» canvas åœ¨ DOM ä¸­ä½äºæœ€åï¼ˆè¿™æ ·åœ¨ z-index ç›¸åŒæ—¶ä¼šåœ¨æœ€ä¸Šå±‚ï¼‰
                                container.appendChild(mainCanvas);
                            }
                            
                            // ç¡®ä¿æ‰€æœ‰å…¶ä»–å…ƒç´ ï¼ˆé™¤äº†è¿”å›æŒ‰é’®ï¼‰ä¸é˜»æŒ¡ canvas
                            const allChildren = Array.from(container.children);
                            allChildren.forEach(child => {
                                if (child.id !== 'close-splat' && child.tagName !== 'CANVAS' && child.id !== 'loading-overlay') {
                                    child.style.pointerEvents = 'none';
                                    child.style.zIndex = '0';
                                }
                            });
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å…ƒç´ åœ¨ canvas ä¹‹ä¸Š
                            const elementsAbove = document.elementsFromPoint(window.innerWidth / 2, window.innerHeight / 2);
                            const canvasIndex = elementsAbove.findIndex(el => el.tagName === 'CANVAS');
                            if (canvasIndex > 0) {
                                console.warn('âš ï¸ å‘ç°å…ƒç´ åœ¨ canvas ä¹‹ä¸Š:', elementsAbove.slice(0, canvasIndex).map(el => el.tagName + (el.id ? '#' + el.id : '')));
                            }
                        }, 500);
                }
            });
            state.viewer.start();
            } catch (err) { 
                console.error(err); 
                loader.style.display = 'none';
                loader.style.pointerEvents = 'none';
            }
        };

        // 4. ç‰©ç†åˆ é™¤é€»è¾‘ [web:31][web:79][web:83]
        document.getElementById('del-btn').onclick = async () => {
            const token = prompt("è¯·è¾“å…¥ HF Write Token ä»¥ç¡®è®¤åˆ é™¤ï¼š");
            if (!token || !confirm("æ°¸ä¹…åˆ é™¤è¯¥æ¨¡å‹åŠç…§ç‰‡ï¼Ÿ")) return;

            const operations = [
                { operation: "delete", path: state.currentLoc.photoPath },
                { operation: "addOrUpdate", path: "locations.json", content: new Blob([JSON.stringify(state.locations.filter(l => l.id !== state.currentLoc.id), null, 2)], {type:"application/json"}) }
            ];
            if (state.currentLoc.splatPath) operations.push({ operation: "delete", path: state.currentLoc.splatPath });

            try {
                await commit({ credentials: { accessToken: token }, repo: { type: "dataset", name: REPO_ID }, title: "Delete location", operations });
                location.reload();
            } catch (e) { alert("åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚"); }
        };

        // ä¿å­˜ DeepL Key
        document.getElementById('deepl-key').value = state.deeplKey;
        document.getElementById('deepl-key').addEventListener('change', (e) => {
            state.deeplKey = e.target.value.trim();
            localStorage.setItem('DEEPL_KEY', state.deeplKey);
        });
        
        // è‡ªåŠ¨ç¿»è¯‘ï¼šå½“è¾“å…¥ä¸­æ–‡æè¿°æ—¶ï¼Œè‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡ï¼ˆä¿å­˜åˆ° state ä¸­ï¼‰
        let autoTranslatedDescEn = '';
        document.getElementById('desc-input').addEventListener('input', async (e) => {
            const descCn = e.target.value.trim();
            if (descCn && state.deeplKey) {
                autoTranslatedDescEn = await translateWithDeepL(descCn);
                console.log('âœ… æè¿°å·²è‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡');
            } else {
                autoTranslatedDescEn = '';
            }
        });
        
        // è‡ªåŠ¨ç¿»è¯‘ï¼šå½“è¾“å…¥ä¸­æ–‡åç§°æ—¶ï¼Œè‡ªåŠ¨ç¿»è¯‘ä¸ºè‹±æ–‡
        document.getElementById('loc-name').addEventListener('input', async (e) => {
            const nameCn = e.target.value.trim();
            const nameEnInput = document.getElementById('loc-name-en');
            if (nameCn && state.deeplKey && !nameEnInput.value.trim()) {
                nameEnInput.placeholder = 'æ­£åœ¨ç¿»è¯‘...';
                const translated = await translateWithDeepL(nameCn);
                nameEnInput.value = translated;
                nameEnInput.placeholder = 'Location Name (Englishï¼Œç•™ç©ºå°†è‡ªåŠ¨ç¿»è¯‘)';
            }
        });
        
        // 5. ä¸Šä¼ ä»»åŠ¡é€»è¾‘
        document.getElementById('submit-btn').onclick = async () => {
            const token = document.getElementById('hf-token').value.trim();
            const file = document.getElementById('photo-input').files[0];
            const name = document.getElementById('loc-name').value.trim();
            let nameEn = document.getElementById('loc-name-en').value.trim();
            const desc = document.getElementById('desc-input').value.trim();
            
            if (!token || !file || !state.selectedCoords || !name) {
                alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯ï¼šTokenã€ç…§ç‰‡ã€åæ ‡å’Œä¸­æ–‡åç§°");
                return;
            }
            
            // å¦‚æœæ²¡æœ‰è‹±æ–‡åç§°ï¼Œå°è¯•ç¿»è¯‘
            if (!nameEn && state.deeplKey) {
                nameEn = await translateWithDeepL(name);
            }
            if (!nameEn) nameEn = name;
            
            // è·å–è‡ªåŠ¨ç¿»è¯‘çš„è‹±æ–‡æè¿°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç¿»è¯‘
            let descEn = autoTranslatedDescEn;
            if (!descEn && desc && state.deeplKey) {
                descEn = await translateWithDeepL(desc);
            }
            if (!descEn) descEn = desc || "";

            const ts = Date.now();
            const safeName = file.name.replace(/[^a-z0-9.]/gi, '_');
            const photoPath = `inputs/${ts}_${safeName}`;
            
            const newLoc = {
                id: ts,
                lat: state.selectedCoords.lat,
                lon: state.selectedCoords.lng,
                name: name,
                name_en: nameEn,
                desc: desc || "",
                desc_en: descEn,
                photoPath: photoPath,
                splatPath: "",
                status: "processing"
            };
            
            const newLocations = [...state.locations, newLoc];

            try {
                await commit({
                    credentials: { accessToken: token },
                    repo: { type: "dataset", name: REPO_ID },
                    title: `Upload task ${ts}`,
                    operations: [
                        { operation: "addOrUpdate", path: photoPath, content: file },
                        { operation: "addOrUpdate", path: "locations.json", content: new Blob([JSON.stringify(newLocations, null, 2)], {type:"application/json"}) }
                    ]
                });
                alert("ä»»åŠ¡ä¸Šä¼ æˆåŠŸï¼");
                document.getElementById('modal-overlay').style.display = 'none';
                // æ¸…ç©ºè¡¨å•ï¼ˆä¿ç•™ DeepL Keyï¼‰
                document.getElementById('hf-token').value = '';
                document.getElementById('loc-name').value = '';
                document.getElementById('loc-name-en').value = '';
                document.getElementById('lat-lon').value = '';
                document.getElementById('photo-input').value = '';
                document.getElementById('desc-input').value = '';
                autoTranslatedDescEn = '';
                state.selectedCoords = null;
                loadLocations();
            } catch (e) {
                alert("ä¸Šä¼ å¤±è´¥ï¼š" + (e.message || e));
            }
        };

        // 6. å…¶ä»–äº¤äº’é€»è¾‘ (æ‹¾å–ã€ä¸Šä¼ ã€AI)
        document.getElementById('upload-btn').onclick = () => document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('pick-btn').onclick = () => { document.getElementById('modal-overlay').style.display = 'none'; state.isPicking = true; };
        map.on('click', (e) => {
            if (state.isPicking) {
                state.selectedCoords = e.latlng;
                document.getElementById('lat-lon').value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                state.isPicking = false;
                document.getElementById('modal-overlay').style.display = 'flex';
            }
        });

        document.getElementById('close-splat').onclick = () => {
            document.getElementById('splat-viewer').style.display = 'none';
            // å…³é—­ 3D è§†å›¾æ—¶æ¢å¤åœ°å›¾å’Œ UI
            document.getElementById('ui-layer').style.display = 'block';
            document.getElementById('map-background').style.display = 'block';
            if (state.viewer) { state.viewer.stop(); state.viewer.dispose(); state.viewer = null; }
        };

        document.getElementById('save-key-btn').onclick = () => {
            const key = document.getElementById('user-gemini-key').value.trim();
            if (key) {
                ACTIVE_GEMINI_KEY = key;
                localStorage.setItem('MY_GEMINI_KEY', key);
                document.getElementById('gemini-config-ui').style.display = 'none';
                document.getElementById('chat-main-ui').style.display = 'flex';
                addChatMessage('agent', 'å¥½å‘€ï¼Œæˆ‘å·²ç»è¿ä¸Š Gemini äº†ï¼Œéšä¾¿é—®æˆ‘å…³äºè¿™ä¸ªåœºæ™¯çš„ä»»ä½•é—®é¢˜ï½');
            }
        };

        // èŠå¤©å‘é€æŒ‰é’®å’Œå›è½¦é”®
        document.getElementById('chat-send').onclick = () => { handleChat(); };
        document.getElementById('chat-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleChat();
            }
        });

        // è¯­è¨€åˆ‡æ¢æŒ‰é’®
        document.getElementById('lang-toggle').onclick = () => {
            state.lang = state.lang === 'cn' ? 'en' : 'cn';
            updateLangUI();
        };

        loadLocations();
        setInterval(loadLocations, 20000);
        updateLangUI();
    </script>
</body>
</html>
