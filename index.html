<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK Gaussian Walk: 3DGS Tracker</title>
    <style>
        :root { --primary: #00ff88; --processing: #ffcc00; --glass: rgba(10, 15, 30, 0.95); --ai-color: #bd34fe; }
        body { margin: 0; overflow: hidden; background: #050510; font-family: 'Segoe UI', sans-serif; color: white; }
        #canvas-container { position: absolute; inset: 0; z-index: 1; }
        body.picking-mode #canvas-container { cursor: crosshair; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .pointer-auto { pointer-events: auto; }
        /* UI Elements */
        #upload-btn { position: absolute; top: 20px; right: 20px; background: linear-gradient(135deg, #00c6ff, #0072ff); border: none; padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; }
        #settings-btn { position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.1); border: 1px solid #444; padding: 10px; border-radius: 50%; cursor: pointer; }
        #picker-toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 200, 0, 0.9); color: black; font-weight: bold; padding: 10px 20px; border-radius: 30px; display: none; }
        #modal-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .modal-box { background: #1a1a2e; padding: 30px; border-radius: 16px; width: 90%; max-width: 400px; border: 1px solid #333; pointer-events: auto; }
        .input-group { margin-bottom: 15px; }
        input, textarea { width: 100%; box-sizing: border-box; background: #0f0f1a; border: 1px solid #333; color: white; padding: 10px; border-radius: 8px; }
        .btn-submit { width: 100%; background: var(--primary); color: black; border:none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: var(--glass); padding: 20px; border-radius: 20px; display: none; backdrop-filter: blur(12px); }
        .action-btn { background: var(--primary); color: #000; border: none; padding: 10px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; float: right; margin-top: -30px; }
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 50; display: none; }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/",
            "@mkkellogg/gaussian-splats-3d": "https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js",
            "@huggingface/hub": "https://cdn.jsdelivr.net/npm/@huggingface/hub@0.15.1/+esm"
        }
    }
    </script>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="picker-toast">üìç Click on HK Map to select location</div>
    <div id="splat-viewer" class="pointer-auto"><button id="close-splat" style="position:absolute;top:20px;left:20px;z-index:60;padding:10px;">‚Üê EXIT</button></div>

    <div id="ui-layer">
        <button id="settings-btn" class="pointer-auto" onclick="UI.openSettings()">‚öôÔ∏è</button>
        <button id="upload-btn" class="pointer-auto" onclick="UI.openUpload()">+ ADD MEMORY</button>
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title" style="margin:0">Hong Kong Spot</h3>
            <p id="loc-status" style="color:var(--processing);font-size:0.8em;"></p>
            <p id="loc-desc" style="color:#aaa;"></p>
            <button id="enter-btn" class="action-btn" onclick="App.enterSplatMode()">VIEW 3D</button>
        </div>

        <div id="modal-overlay" class="pointer-auto">
            <div class="modal-box">
                <h3>New HK Memory</h3>
                <div class="input-group"><label>HF Token</label><input type="password" id="hf-token"></div>
                <div class="input-group">
                    <label>Coordinates</label>
                    <div style="display:flex;gap:5px;"><input type="number" id="lat" placeholder="Lat"><input type="number" id="lon" placeholder="Lon">
                    <button class="pointer-auto" onclick="App.startPickerMode()" style="cursor:pointer">üìç Pick</button></div>
                </div>
                <div class="input-group"><label>Photo</label><input type="file" id="photo"></div>
                <div class="input-group"><label>Story</label><textarea id="desc"></textarea></div>
                <button class="btn-submit" onclick="App.handleUpload()">UPLOAD TO GPU</button>
                <button onclick="UI.closeUpload()" style="width:100%;background:none;color:#888;border:none;margin-top:10px;cursor:pointer">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';
        import { commit } from '@huggingface/hub';

        const REPO_ID = "ColinWong24/my-gaussian-world"; // ÊõøÊç¢‰∏∫‰Ω†ÁöÑ‰ªìÂ∫ì
        const HK_BOUNDS = { latMin: 22.15, latMax: 22.58, lonMin: 113.83, lonMax: 114.45 };
        const MAP_SIZE = { w: 144, h: 100 }; // Âü∫‰∫éÁªèÁ∫¨Â∫¶ÊØî‰æã

        const state = { locations: [], currentLoc: null, viewer: null, isPicking: false };

        const App = {
            init: async function() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 2000);
                this.camera.position.set(0, -60, 150);
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                
                // Âä†ËΩΩÈ¶ôÊ∏ØÂú∞ÂõæÂπ≥Èù¢
                const tex = new THREE.TextureLoader().load('https://upload.wikimedia.org/wikipedia/commons/thumb/e/e3/Hong_Kong_Location_Map.svg/1200px-Hong_Kong_Location_Map.svg.png');
                this.map = new THREE.Mesh(new THREE.PlaneGeometry(MAP_SIZE.w, MAP_SIZE.h), new THREE.MeshBasicMaterial({ map: tex }));
                this.scene.add(this.map);
                
                this.markerGroup = new THREE.Group();
                this.scene.add(this.markerGroup);

                window.addEventListener('pointerdown', (e) => this.onClick(e));
                await this.loadLocations();
                this.animate();
            },

            latLonToPos: (lat, lon) => {
                const x = ((lon - HK_BOUNDS.lonMin) / (HK_BOUNDS.lonMax - HK_BOUNDS.lonMin) - 0.5) * MAP_SIZE.w;
                const y = ((lat - HK_BOUNDS.latMin) / (HK_BOUNDS.latMax - HK_BOUNDS.latMin) - 0.5) * MAP_SIZE.h;
                return new THREE.Vector3(x, y, 1);
            },

            loadLocations: async function() {
                const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
                state.locations = await res.json();
                this.markerGroup.clear();
                state.locations.forEach(loc => {
                    const mesh = new THREE.Mesh(new THREE.SphereGeometry(1.5), new THREE.MeshBasicMaterial({ color: loc.status==='processing'?0xffcc00:0x00ff88 }));
                    mesh.position.copy(this.latLonToPos(loc.lat, loc.lon));
                    mesh.userData = loc;
                    this.markerGroup.add(mesh);
                });
            },

            startPickerMode: function() { state.isPicking = true; document.getElementById('modal-overlay').style.display='none'; document.getElementById('picker-toast').style.display='block'; },

            onClick: function(e) {
                if(e.target.closest('.pointer-auto')) return;
                const ray = new THREE.Raycaster();
                const m = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
                ray.setFromCamera(m, this.camera);

                if(state.isPicking) {
                    const hits = ray.intersectObject(this.map);
                    if(hits.length>0) {
                        const p = hits[0].point;
                        const lon = ((p.x/MAP_SIZE.w)+0.5)*(HK_BOUNDS.lonMax-HK_BOUNDS.lonMin)+HK_BOUNDS.lonMin;
                        const lat = ((p.y/MAP_SIZE.h)+0.5)*(HK_BOUNDS.latMax-HK_BOUNDS.latMin)+HK_BOUNDS.latMin;
                        document.getElementById('lat').value = lat.toFixed(4);
                        document.getElementById('lon').value = lon.toFixed(4);
                        state.isPicking=false; document.getElementById('picker-toast').style.display='none'; document.getElementById('modal-overlay').style.display='flex';
                    }
                } else {
                    const hits = ray.intersectObjects(this.markerGroup.children);
                    if(hits.length>0) {
                        state.currentLoc = hits[0].object.userData;
                        document.getElementById('info-bar').style.display='block';
                        document.getElementById('loc-desc').innerText = state.currentLoc.desc;
                        document.getElementById('loc-status').innerText = state.currentLoc.status==='processing'?'‚åõ GPU Processing...':'';
                    }
                }
            },

            handleUpload: async function() {
                const token = document.getElementById('hf-token').value;
                const file = document.getElementById('photo').files[0];
                const lat = parseFloat(document.getElementById('lat').value);
                const lon = parseFloat(document.getElementById('lon').value);
                const ts = Date.now();
                const path = `inputs/${ts}.jpg`;
                
                state.locations.push({ id: ts, lat, lon, desc: document.getElementById('desc').value, photoPath: path, splatPath: "", status: "processing" });
                
                await commit({
                    credentials: { accessToken: token },
                    repo: { type: "dataset", name: REPO_ID },
                    operations: [
                        { operation: "addOrUpdate", path: path, content: file },
                        { operation: "addOrUpdate", path: "locations.json", content: new Blob([JSON.stringify(state.locations, null, 2)], {type:"application/json"}) }
                    ],
                    title: `HK Task ${ts}`
                });
                location.reload();
            },

            enterSplatMode: function() {
                if(!state.currentLoc || state.currentLoc.status==='processing') return;
                document.getElementById('splat-viewer').style.display='block';
                const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.currentLoc.splatPath}`;
                if(!state.viewer) {
                    state.viewer = new GaussianSplats3D.Viewer({ 'cameraUp':[0,-1,-0.6], 'initialCameraPosition':[-1,-4,6], 'rootElement':document.getElementById('splat-viewer') });
                    state.viewer.init();
                }
                state.viewer.addSplatScene(url, {'streamView':true}).then(()=>state.viewer.start());
            },

            animate: function() { requestAnimationFrame(()=>this.animate()); this.renderer.render(this.scene, this.camera); }
        };
        document.getElementById('close-splat').onclick = () => document.getElementById('splat-viewer').style.display='none';
        App.init();
        window.UI = { openUpload:()=>document.getElementById('modal-overlay').style.display='flex', closeUpload:()=>document.getElementById('modal-overlay').style.display='none' };
    </script>
</body>
</html>
