<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Hub | Pro Auto-Translate</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
    <style>
        :root { --primary: #00ff88; --danger: #ff4444; --glass: rgba(10, 15, 30, 0.95); --accent: #0072ff; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
        #map-background { position: absolute; inset: 0; z-index: 1; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }
        #lang-toggle { position: absolute; top: 20px; left: 20px; background: var(--glass); color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 20px; cursor: pointer; z-index: 1001; }
        #upload-btn { position: absolute; top: 20px; right: 20px; background: var(--accent); border: none; padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; z-index: 1001; }
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: white; display: none; }
        #status-tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-bottom: 8px; font-weight: bold; }
        .status-ready { background: #00ff8822; color: #00ff88; }
        .status-busy { background: #ffcc0022; color: #ffcc00; }
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 2000; display: none; }
        #close-splat { position: absolute; top: 20px; left: 20px; z-index: 2100; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer; }
        #chat-window { position: absolute; bottom: 20px; right: 20px; width: 320px; height: 400px; background: rgba(10, 15, 30, 0.95); backdrop-filter: blur(15px); border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; z-index: 2100; box-shadow: 0 12px 40px rgba(0,0,0,0.6); overflow: hidden; }
        #chat-msgs { flex: 1; padding: 12px; overflow-y: auto; font-size: 0.85em; color: #eee; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 85%; line-height: 1.5; word-wrap: break-word; }
        .msg-agent { background: var(--accent); align-self: flex-start; }
        .msg-user { background: #333; align-self: flex-end; }
        #chat-input-wrap { display: flex; border-top: 1px solid rgba(255,255,255,0.1); padding: 10px; background: rgba(0,0,0,0.3); }
        #chat-input { flex: 1; background: transparent; border: none; color: white; outline: none; }
        #gemini-config-ui { padding: 30px; text-align: center; height: 100%; display: flex; flex-direction: column; justify-content: center; box-sizing: border-box; }
        #chat-main-ui { display: none; flex-direction: column; height: 100%; }
        #modal-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 3000; }
        .modal-box { background: #151525; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; color: white; border: 1px solid #333; }
        input, textarea { width: 100%; box-sizing: border-box; background: #050510; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; margin: 10px 0; }
        #picker-toast { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); background: #ffcc00; color: #000; font-weight: bold; padding: 10px 25px; border-radius: 30px; display: none; z-index: 4000; }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "@huggingface/hub": "https://cdn.jsdelivr.net/npm/@huggingface/hub@0.15.1/+esm"
        }
    }
    </script>
</head>
<body>
    <div id="map-background"></div>
    <div id="picker-toast">ğŸ“ <span data-i18n="picker_hint">ç‚¹å‡»åœ°å›¾æ‹¾å–åæ ‡ç‚¹...</span></div>

    <div id="splat-viewer" class="pointer-auto">
        <button id="close-splat" data-i18n="btn_back">è¿”å›åœ°å›¾</button>
        <div id="chat-window">
            <div id="gemini-config-ui">
                <p style="font-size: 0.9em; color: #00ff88; margin-bottom: 10px; font-weight: bold;">ğŸ‘¤ æ¿€æ´» AI å¯¼è§ˆå‘˜</p>
                <input type="password" id="user-gemini-key" placeholder="Gemini API Key...">
                <input type="password" id="user-deepl-key" placeholder="DeepL API Key (å¯é€‰)...">
                <button id="save-key-btn" style="background:var(--accent); color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;">ä¿å­˜å¯†é’¥å¹¶å¼€å¯</button>
                <p style="font-size:0.7em; color:#666; margin-top:10px;">DeepL Key ç”¨äºä¸Šä¼ ä»»åŠ¡æ—¶è‡ªåŠ¨ç”Ÿæˆç¿»è¯‘</p>
            </div>
            <div id="chat-main-ui">
                <div id="chat-msgs"></div>
                <div id="chat-input-wrap">
                    <input type="text" id="chat-input" placeholder="å‘ä½œè€…æé—®..." data-i18n-placeholder="chat_placeholder">
                    <button id="chat-send" style="background:none; border:none; color:var(--primary); cursor:pointer; font-weight:bold;">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ui-layer">
        <button id="lang-toggle" class="pointer-auto">EN / ä¸­</button>
        <button id="upload-btn" class="pointer-auto" data-i18n="btn_new">+ æ–°å¢ä»»åŠ¡</button>
        <div id="info-bar" class="pointer-auto">
            <div id="status-tag"></div>
            <h3 id="loc-title" style="margin:0"></h3>
            <p id="loc-desc" style="color:#aaa; font-size:0.9em; margin:10px 0;"></p>
            <div style="display:flex; justify-content:flex-end;">
                <button id="enter-btn" style="background:var(--primary); border:none; padding:10px 30px; border-radius:25px; font-weight:bold; cursor:pointer; color:#000;" data-i18n="btn_enter">å…¨æ¯æŸ¥çœ‹</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay" class="pointer-auto">
        <div class="modal-box">
            <h3 data-i18n="modal_title" style="margin-top:0">é…ç½® 3DGS ä»»åŠ¡</h3>
            <input type="password" id="hf-token" placeholder="HF Write Token">
            <input type="text" id="loc-name-cn" placeholder="åœ°ç‚¹åç§° (ä¸­æ–‡)">
            <input type="text" id="loc-name-en" placeholder="Location Name (EN)">
            <div style="display:flex; gap:8px;">
                <input type="text" id="lat-lon-display" readonly placeholder="ç‚¹å‡»æ‹¾å–åæ ‡">
                <button id="picker-btn" style="background:var(--accent); color:white; border:none; border-radius:8px; padding:0 15px; cursor:pointer;" data-i18n="btn_pick">æ‹¾å–</button>
            </div>
            <input type="file" id="photo" accept="image/*">
            <textarea id="desc" rows="2" placeholder="å¡«å†™ä¸­æ–‡æè¿°ï¼ŒDeepL å°†è‡ªåŠ¨ç¿»è¯‘..."></textarea>
            <button id="submit-btn" style="width:100%; background:var(--primary); padding:14px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; color:#000; margin-top:10px;" data-i18n="btn_submit">æäº¤ä»»åŠ¡</button>
            <button id="cancel-btn" style="width:100%; background:none; color:#888; border:none; margin-top:10px; cursor:pointer;" data-i18n="btn_cancel">å–æ¶ˆ</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <script type="module">
        import { commit } from '@huggingface/hub';
        import * as THREE from 'three';
        import * as GaussianSplats3D from 'https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js';

        // å¯†é’¥ç®¡ç†
        let ACTIVE_GEMINI_KEY = localStorage.getItem('MY_GEMINI_KEY') || "";
        let DEEPL_AUTH_KEY = localStorage.getItem('MY_DEEPL_KEY') || "";

        const REPO_ID = "ColinWong24/my-gaussian-world";
        const state = { locations: [], currentLoc: null, lang: 'cn', viewer: null, isPicking: false };
        const i18n = {
            cn: { btn_new: "+ æ–°å¢ä»»åŠ¡", btn_back: "â† è¿”å›åœ°å›¾", btn_enter: "å…¨æ¯æŸ¥çœ‹", btn_pick: "æ‹¾å–", btn_submit: "æäº¤ä»»åŠ¡", btn_cancel: "å–æ¶ˆ", modal_title: "3D é‡å»ºé…ç½®", picker_hint: "è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»æ‹¾å–åæ ‡ç‚¹...", chat_placeholder: "å‘ä½œè€…æé—®...", status_ready: "âœ… æ¨¡å‹å·²å°±ç»ª", status_busy: "âŒ› GPU é‡å»ºä¸­...", welcome: "ä½ å¥½ï¼æˆ‘æ‹æ‘„äº†è¿™ä¸ªåœºæ™¯ï¼Œæƒ³äº†è§£ä»€ä¹ˆï¼Ÿ" },
            en: { btn_new: "+ New Task", btn_back: "â† Back", btn_enter: "View 3D", btn_pick: "Pick Loc", btn_submit: "Submit", btn_cancel: "Cancel", modal_title: "3D GS Config", picker_hint: "Click map to pick...", chat_placeholder: "Ask author...", status_ready: "âœ… Ready", status_busy: "âŒ› Processing...", welcome: "Hi! I captured this. Any questions?" }
        };

        const map = L.map('map-background', { center: [22.3193, 114.1694], zoom: 13, zoomControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);

        // è‡ªåŠ¨ç¿»è¯‘å‡½æ•° [attached_file:1][web:39]
        async function autoTranslateToEn(textCn) {
            if (!textCn || !DEEPL_AUTH_KEY) return textCn;
            try {
                const res = await fetch("https://api-free.deepl.com/v2/translate", {
                    method: 'POST',
                    headers: { 'Authorization': `DeepL-Auth-Key ${DEEPL_AUTH_KEY}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: [textCn], target_lang: 'EN' })
                });
                const data = await res.json();
                return data.translations[0].text;
            } catch (e) { return textCn; }
        }

        document.addEventListener('click', async (e) => {
            const id = e.target.id;
            if (id === 'lang-toggle') { state.lang = state.lang === 'cn' ? 'en' : 'cn'; updateUI(); }
            if (id === 'upload-btn') document.getElementById('modal-overlay').style.display = 'flex';
            if (id === 'cancel-btn') document.getElementById('modal-overlay').style.display = 'none';
            if (id === 'picker-btn') { document.getElementById('modal-overlay').style.display = 'none'; document.getElementById('picker-toast').style.display = 'block'; state.isPicking = true; }
            if (id === 'chat-send') handleChat();
            if (id === 'submit-btn') handleUpload();
            if (id === 'close-splat') { document.getElementById('splat-viewer').style.display = 'none'; if(state.viewer) state.viewer.stop(); }
            if (id === 'save-key-btn') {
                ACTIVE_GEMINI_KEY = document.getElementById('user-gemini-key').value.trim();
                DEEPL_AUTH_KEY = document.getElementById('user-deepl-key').value.trim();
                localStorage.setItem('MY_GEMINI_KEY', ACTIVE_GEMINI_KEY);
                localStorage.setItem('MY_DEEPL_KEY', DEEPL_AUTH_KEY);
                showChatUI();
            }
        });

        map.on('click', (e) => {
            if (state.isPicking) {
                document.getElementById('lat-lon-display').value = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
                state.selectedCoords = e.latlng; state.isPicking = false;
                document.getElementById('picker-toast').style.display = 'none';
                document.getElementById('modal-overlay').style.display = 'flex';
            }
        });

        function showChatUI() {
            if (!ACTIVE_GEMINI_KEY) return;
            document.getElementById('gemini-config-ui').style.display = 'none';
            document.getElementById('chat-main-ui').style.display = 'flex';
            if (document.getElementById('chat-msgs').children.length === 0) addChatMessage('agent', i18n[state.lang].welcome);
        }

        async function handleChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text || !ACTIVE_GEMINI_KEY) return;
            addChatMessage('user', text); input.value = "";
            const sys = `ä»¥ç¬¬ä¸€äººç§°æ‰®æ¼”æ‹æ‘„è€…ã€‚åœ°ç‚¹: ${state.currentLoc.name}, èƒŒæ™¯: ${state.currentLoc.desc}ã€‚å£è¯­åŒ–ç®€çŸ­å›ç­”ï¼Œå¤šç”¨â€œå””â€ã€â€œå”‰â€ç­‰ã€‚è¯­è¨€: ${state.lang === 'cn' ? 'ä¸­æ–‡' : 'è‹±æ–‡'}ã€‚`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${ACTIVE_GEMINI_KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: sys + "\né—®ï¼š" + text }] }] })
                });
                const data = await res.json();
                addChatMessage('agent', data.candidates[0].content.parts[0].text);
            } catch (e) { addChatMessage('agent', "AI å“åº”å¤±è´¥ã€‚"); }
        }

        function addChatMessage(role, text) {
            const msgs = document.getElementById('chat-msgs');
            const d = document.createElement('div'); d.className = `msg msg-${role}`; d.innerText = text;
            msgs.appendChild(d); msgs.scrollTop = msgs.scrollHeight;
        }

        document.getElementById('enter-btn').onclick = async () => {
            const container = document.getElementById('splat-viewer');
            container.style.display = 'block';
            if (ACTIVE_GEMINI_KEY) showChatUI();
            else { document.getElementById('gemini-config-ui').style.display = 'flex'; document.getElementById('chat-main-ui').style.display = 'none'; }
            
            const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.currentLoc.splatPath}`;
            if (!state.viewer) {
                state.viewer = new GaussianSplats3D.Viewer({ 'rootElement': container, 'cameraUp': [0, -1, 0], 'initialCameraPosition': [0, 0, 5], 'showSceneStatePlaceholder': false });
                await state.viewer.init();
            }
            await state.viewer.addSplatScene(url, {
                'onSceneLoad': (scene) => {
                    const mesh = scene.object3D;
                    mesh.rotation.y = Math.PI; 
                    const box = new THREE.Box3().setFromObject(mesh);
                    const center = box.getCenter(new THREE.Vector3());
                    mesh.position.sub(center); 
                    const size = box.getSize(new THREE.Vector3());
                    const cameraZ = Math.abs(Math.max(size.x, size.y) / 2 / Math.tan(state.viewer.camera.fov * Math.PI / 360)) * 1.5;
                    state.viewer.camera.position.set(0, 0, cameraZ);
                    state.viewer.camera.lookAt(0, 0, 0);
                    if(state.viewer.controls) state.viewer.controls.target.set(0, 0, 0);
                }
            });
            state.viewer.start();
        };

        async function handleUpload() {
            const token = document.getElementById('hf-token').value.trim();
            const file = document.getElementById('photo').files[0];
            if(!token || !file || !state.selectedCoords) return alert("ä¿¡æ¯ä¸å…¨ï¼");
            
            const descCn = document.getElementById('desc').value || "";
            // è‡ªåŠ¨ç¿»è¯‘é€»è¾‘ [web:30]
            const descEn = await autoTranslateToEn(descCn);

            const ts = Date.now();
            const safeName = file.name.replace(/[^a-z0-9.]/gi, '_');
            const photoPath = `inputs/${ts}_${safeName}`;
            const newLocs = [...state.locations, { 
                id: ts, lat: state.selectedCoords.lat, lon: state.selectedCoords.lng, 
                name: document.getElementById('loc-name-cn').value || "æœªå‘½å", 
                name_en: document.getElementById('loc-name-en').value || "Unnamed", 
                desc: descCn, desc_en: descEn, photoPath, splatPath: "", status: "processing" 
            }];

            try {
                await commit({
                    credentials: { accessToken: token }, repo: { type: "dataset", name: REPO_ID },
                    title: `Upload task ${ts}`,
                    operations: [
                        { operation: "addOrUpdate", path: photoPath, content: file },
                        { operation: "addOrUpdate", path: "locations.json", content: new Blob([JSON.stringify(newLocs, null, 2)], {type:"application/json"}) }
                    ]
                });
                location.reload();
            } catch (e) { alert("ä¸Šä¼ å¤±è´¥ã€‚"); }
        }

        function updateUI() {
            document.querySelectorAll('[data-i18n]').forEach(el => { el.innerText = i18n[state.lang][el.getAttribute('data-i18n')]; });
            if (state.currentLoc) {
                const isCn = state.lang === 'cn';
                document.getElementById('loc-title').innerText = isCn ? state.currentLoc.name : state.currentLoc.name_en;
                document.getElementById('loc-desc').innerText = isCn ? state.currentLoc.desc : (state.currentLoc.desc_en || state.currentLoc.desc);
            }
        }

        async function loadLocations() {
            try {
                const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
                state.locations = await res.json();
                markerGroup.clearLayers();
                state.locations.forEach(loc => {
                    const ready = loc.status === 'ready';
                    L.circleMarker([loc.lat, loc.lon], { radius: 10, fillColor: ready ? '#00ff88' : '#ffcc00', fillOpacity: 0.9, weight: 2, color: '#fff' })
                    .addTo(markerGroup).on('click', () => {
                        state.currentLoc = loc;
                        document.getElementById('info-bar').style.display = 'block';
                        updateUI();
                    });
                });
            } catch(e){ state.locations = []; }
        }

        loadLocations(); updateUI();
        setInterval(loadLocations, 15000);
    </script>
</body>
</html>
