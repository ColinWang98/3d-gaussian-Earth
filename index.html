<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Hub | Pro Holographic Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #00ff88; --glass: rgba(10, 15, 30, 0.95); --accent: #0072ff; }
        body, html { margin: 0; height: 100%; background: #000; font-family: system-ui, sans-serif; overflow: hidden; }
        #map-background { position: absolute; inset: 0; z-index: 1; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }
        #upload-btn { position: absolute; top: 20px; right: 20px; background: var(--accent); border: none; padding: 12px 24px; border-radius: 50px; color: white; cursor: pointer; font-weight: bold; }
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: white; display: none; }
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 2000; display: none; }
        #chat-window { position: absolute; bottom: 20px; right: 20px; width: 320px; height: 400px; background: var(--glass); border-radius: 15px; display: flex; flex-direction: column; border: 1px solid #333; }
        #chat-msgs { flex: 1; padding: 10px; overflow-y: auto; color: #eee; font-size: 0.9em; }
        .msg { padding: 8px 12px; border-radius: 10px; margin-bottom: 8px; max-width: 80%; }
        .msg-agent { background: var(--accent); align-self: flex-start; }
        .msg-user { background: #333; align-self: flex-end; }
    </style>
    <script type="importmap">{ "imports": { 
        "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
        "@huggingface/hub": "https://cdn.jsdelivr.net/npm/@huggingface/hub@0.15.1/+esm" 
    }}</script>
</head>
<body>
    <div id="map-background"></div>
    <div id="splat-viewer" class="pointer-auto">
        <button onclick="location.reload()" style="position:absolute; top:20px; left:20px; z-index:2100; padding:10px; border-radius:20px; cursor:pointer;">返回地图</button>
        <div id="chat-window"><div id="chat-msgs"></div><input type="text" id="chat-input" placeholder="提问..."></div>
    </div>

    <div id="ui-layer">
        <button id="upload-btn" class="pointer-auto">+ 新增重建任务</button>
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title"></h3><p id="loc-desc"></p>
            <button id="enter-btn" style="background:var(--primary); width:100%; padding:10px; border-radius:10px; font-weight:bold; cursor:pointer;">进入全息影像</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { commit } from '@huggingface/hub';
        import * as THREE from 'three';
        import * as GaussianSplats3D from 'https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js';

        const REPO_ID = "ColinWong24/my-gaussian-world";
        const state = { locations: [], current: null, viewer: null };

        // 初始化地图 [web:13]
        const map = L.map('map-background', { center: [22.3193, 114.1694], zoom: 13, zoomControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function loadData() {
            const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
            state.locations = await res.json();
            state.locations.forEach(loc => {
                L.circleMarker([loc.lat, loc.lon], { color: loc.status === 'ready' ? '#00ff88' : '#ffcc00' })
                .addTo(map).on('click', () => {
                    state.current = loc;
                    document.getElementById('loc-title').innerText = loc.name;
                    document.getElementById('info-bar').style.display = 'block';
                });
            });
        }

        document.getElementById('enter-btn').onclick = async () => {
            const container = document.getElementById('splat-viewer');
            container.style.display = 'block';
            const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.current.splatPath}`;
            
            state.viewer = new GaussianSplats3D.Viewer({ rootElement: container, cameraUp: [0, -1, 0] });
            await state.viewer.init();
            await state.viewer.addSplatScene(url, {
                onSceneLoad: (scene) => {
                    const mesh = scene.object3D;
                    mesh.rotation.y = Math.PI; // Y 轴旋转 180° [web:10]
                    const box = new THREE.Box3().setFromObject(mesh);
                    mesh.position.sub(box.getCenter(new THREE.Vector3())); // 强制对齐中心 [web:5]
                }
            });
            state.viewer.start();
        };

        loadData();
    </script>
</body>
</html>
