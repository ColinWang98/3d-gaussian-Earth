<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Hub | Pro Holographic Map</title>
    <!-- 引入地图样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="icon" href="data:;base64,iVBORw0KGgo="> <!-- 修复 favicon 404 -->
    <style>
        :root { --primary: #00ff88; --glass: rgba(10, 15, 30, 0.95); --accent: #0072ff; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; font-family: system-ui, sans-serif; overflow: hidden; }
        #map-background { position: absolute; inset: 0; z-index: 1; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }
        #upload-btn { position: absolute; top: 20px; right: 20px; background: var(--accent); border: none; padding: 12px 24px; border-radius: 50px; color: white; cursor: pointer; font-weight: bold; }
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: white; display: none; }
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 2000; display: none; }
        #close-btn { position: absolute; top: 20px; left: 20px; z-index: 2100; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer; }
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 2050; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script type="importmap">{ "imports": { 
        "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
        "@huggingface/hub": "https://cdn.jsdelivr.net/npm/@huggingface/hub@0.15.1/+esm" 
    }}</script>
</head>
<body>
    <div id="map-background"></div>
    
    <div id="splat-viewer" class="pointer-auto">
        <div id="loading-overlay">
            <div class="spinner"></div>
            <div id="load-status">正在解析全息数据...</div>
        </div>
        <button id="close-btn">← 返回地图</button>
    </div>

    <div id="ui-layer">
        <button id="upload-btn" class="pointer-auto" onclick="window.open('https://huggingface.co/datasets/ColinWong24/my-gaussian-world')">管理数据仓库</button>
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title" style="margin:0 0 5px 0"></h3>
            <p id="loc-desc" style="color:#aaa; font-size:0.85em; margin-bottom:15px;"></p>
            <button id="enter-btn" style="background:var(--primary); width:100%; padding:12px; border-radius:10px; font-weight:bold; cursor:pointer; color:#000; border:none;">启动全息渲染</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import * as THREE from 'three';
        import * as GaussianSplats3D from 'https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js';

        const REPO_ID = "ColinWong24/my-gaussian-world";
        const state = { locations: [], current: null, viewer: null };

        // 1. 初始化 2D 地图
        const map = L.map('map-background', { center: [22.3193, 114.1694], zoom: 13, zoomControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        async function loadLocations() {
            try {
                const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
                if (!res.ok) throw new Error("无法读取 locations.json");
                state.locations = await res.json();
                state.locations.forEach(loc => {
                    const ready = loc.status === 'ready';
                    L.circleMarker([loc.lat, loc.lon], { 
                        radius: 9, color: ready ? '#00ff88' : '#ffcc00', fillOpacity: 0.8 
                    }).addTo(map).on('click', () => {
                        state.current = loc;
                        document.getElementById('loc-title').innerText = loc.name;
                        document.getElementById('loc-desc').innerText = loc.desc || "处理中，请稍后...";
                        document.getElementById('info-bar').style.display = 'block';
                        document.getElementById('enter-btn').disabled = !ready;
                        document.getElementById('enter-btn').style.opacity = ready ? "1" : "0.5";
                    });
                });
            } catch(e) { console.error("初始化加载失败:", e); }
        }

        // 2. 3D 渲染核心修复逻辑 [web:63][web:69][web:73]
        document.getElementById('enter-btn').onclick = async () => {
            if (!state.current || !state.current.splatPath) return;

            const container = document.getElementById('splat-viewer');
            const loader = document.getElementById('loading-overlay');
            container.style.display = 'block';
            loader.style.display = 'flex';

            // 彻底销毁旧实例，清理加载队列，解决 Cannot add splat scene while another load... [web:72]
            if (state.viewer) {
                state.viewer.dispose();
                state.viewer = null;
            }

            // 核心修复配置：GitHub Pages 环境必须关闭共享内存和多线程 [web:69]
            state.viewer = new GaussianSplats3D.Viewer({
                rootElement: container,
                cameraUp: [0, -1, 0],
                initialCameraPosition: [0, 0, 5],
                sharedMemoryForWorkers: false, // 修复 DataCloneError
                webWorkerCount: 0,             // 强制单线程解析，避开安全限制
                showSceneStatePlaceholder: false
            });

            await state.viewer.init();
            
            // 拼接最新的 URL，防止缓存 404
            const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.current.splatPath}?t=${Date.now()}`;
            console.log("正在请求模型:", url);

            try {
                await state.viewer.addSplatScene(url, {
                    'onSceneLoad': (scene) => {
                        loader.style.display = 'none';
                        const mesh = scene.object3D;
                        mesh.rotation.y = Math.PI; // Y轴旋转180度适配
                        
                        // 自动居中对齐 [web:5]
                        const box = new THREE.Box3().setFromObject(mesh);
                        const center = new THREE.Vector3();
                        box.getCenter(center);
                        mesh.position.sub(center);
                    }
                });
                state.viewer.start();
            } catch (err) {
                console.error("加载失败:", err);
                alert("渲染引擎启动失败，请检查网络或模型文件。");
                loader.style.display = 'none';
            }
        };

        document.getElementById('close-btn').onclick = () => {
            document.getElementById('splat-viewer').style.display = 'none';
            if (state.viewer) state.viewer.stop();
        };

        // 首次加载
        loadLocations();
    </script>
</body>
</html>
