<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Tracker | Advanced</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <style>
        :root { --primary: #00ff88; --danger: #ff4444; --glass: rgba(10, 15, 30, 0.95); }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map-background { position: absolute; inset: 0; z-index: 1; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }
        
        #lang-toggle { position: absolute; top: 20px; left: 20px; background: var(--glass); color: white; border: 1px solid #444; padding: 8px 15px; border-radius: 20px; cursor: pointer; }
        #upload-btn { position: absolute; top: 20px; right: 20px; background: #0072ff; border: none; padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; }
        
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: white; display: none; }
        .info-btns { display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end; }
        .btn-del { background: none; border: 1px solid var(--danger); color: var(--danger); padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 0.85em; }
        
        #modal-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); justify-content: center; align-items: center; z-index: 3000; }
        .modal-box { background: #151525; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; color: white; }
        input { width: 100%; box-sizing: border-box; background: #050510; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; margin: 8px 0; }
        
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 2000; display: none; }
        #close-splat { position: absolute; top: 20px; left: 20px; z-index: 2100; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer; }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "@huggingface/hub": "https://cdn.jsdelivr.net/npm/@huggingface/hub@0.15.1/+esm"
        }
    }
    </script>
</head>
<body>
    <div id="map-background"></div>
    <div id="splat-viewer" class="pointer-auto"><button id="close-splat">Return</button></div>

    <div id="ui-layer">
        <button id="lang-toggle" class="pointer-auto">EN / 中</button>
        <button id="upload-btn" class="pointer-auto">+ New Task</button>
        
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title" style="margin:0"></h3>
            <p id="loc-desc" style="color:#aaa; font-size:0.9em; margin:10px 0;"></p>
            <div class="info-btns">
                <button class="btn-del" id="del-btn" data-i18n="btn_del">删除点位</button>
                <button id="enter-btn" style="background:#00ff88; border:none; padding:8px 20px; border-radius:20px; font-weight:bold; cursor:pointer;" data-i18n="btn_enter">查看 3D</button>
            </div>
        </div>
    </div>

    <!-- 交互弹窗 -->
    <div id="modal-overlay" class="pointer-auto">
        <div class="modal-box" id="modal-content"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { commit } from '@huggingface/hub';
        import * as THREE from 'three';
        import * as GaussianSplats3D from 'https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js';

        const REPO_ID = "ColinWong24/my-gaussian-world";
        const state = { locations: [], currentLoc: null, lang: 'cn', viewer: null };

        const i18n = {
            cn: { btn_del: "删除点位", btn_enter: "全息查看", del_confirm: "请输入 HF Write Token 以确认删除:", auth_err: "密钥验证失败或取消操作" },
            en: { btn_del: "Delete", btn_enter: "Hologram", del_confirm: "Enter HF Write Token to confirm deletion:", auth_err: "Auth failed or cancelled" }
        };

        const map = L.map('map-background', { center: [22.3193, 114.1694], zoom: 13, zoomControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);

        // 1. 点位删除功能 [web:148][web:151]
        document.getElementById('del-btn').onclick = async () => {
            const token = prompt(i18n[state.lang].del_confirm);
            if (!token) return;

            const updatedLocations = state.locations.filter(l => l.id !== state.currentLoc.id);
            try {
                await commit({
                    credentials: { accessToken: token },
                    repo: { type: "dataset", name: REPO_ID },
                    operations: [{ 
                        operation: "addOrUpdate", 
                        path: "locations.json", 
                        content: new Blob([JSON.stringify(updatedLocations, null, 2)], {type:"application/json"}) 
                    }],
                    title: `Delete Point ${state.currentLoc.id}`
                });
                location.reload();
            } catch (e) { alert(i18n[state.lang].auth_err); }
        };

        // 2. 3D 渲染与自适应居中 [web:179][web:181]
        document.getElementById('enter-btn').onclick = async () => {
            const container = document.getElementById('splat-viewer');
            container.style.display = 'block';
            const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.currentLoc.splatPath}`;

            if (!state.viewer) {
                state.viewer = new GaussianSplats3D.Viewer({
                    'rootElement': container,
                    'cameraUp': [0, -1, 0],
                    'initialCameraPosition': [0, 0, 5],
                    'sharedMemoryForWorkers': false
                });
                await state.viewer.init();
            }

            await state.viewer.addSplatScene(url, { 
                'onProgress': (p) => {},
                'onSceneLoad': (scene) => {
                    // 自适应居中逻辑 [web:189]
                    const box = new THREE.Box3().setFromObject(scene.object3D);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    // 将相机对准物体中心并调整距离 [web:181]
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const fov = state.viewer.camera.fov * (Math.PI / 180);
                    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                    cameraZ *= 1.2; // 留一点边距

                    state.viewer.camera.position.set(center.x, center.y, center.z + cameraZ);
                    state.viewer.camera.lookAt(center);
                    if(state.viewer.controls) state.viewer.controls.target.copy(center);
                }
            });
            state.viewer.start();
        };

        async function loadLocations() {
            const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
            state.locations = await res.json();
            markerGroup.clearLayers();
            state.locations.forEach(loc => {
                L.circleMarker([loc.lat, loc.lon], { radius: 10, fillColor: loc.status==='ready'?'#00ff88':'#ffcc00', fillOpacity: 0.9, weight: 2, color: '#fff' })
                .addTo(markerGroup).on('click', () => {
                    state.currentLoc = loc;
                    document.getElementById('info-bar').style.display = 'block';
                    document.getElementById('loc-title').innerText = state.lang==='cn'?loc.name:loc.name_en;
                    document.getElementById('loc-desc').innerText = loc.desc;
                });
            });
        }

        document.getElementById('close-splat').onclick = () => { document.getElementById('splat-viewer').style.display = 'none'; };
        document.getElementById('lang-toggle').onclick = () => { state.lang = state.lang==='cn'?'en':'cn'; loadLocations(); };
        loadLocations();
    </script>
</body>
</html>
