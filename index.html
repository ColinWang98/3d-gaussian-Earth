<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Hub | Pro Holographic Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
    <style>
        :root { --primary: #00ff88; --danger: #ff4444; --glass: rgba(10, 15, 30, 0.95); --accent: #0072ff; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map-background { position: absolute; inset: 0; z-index: 1; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }
        #upload-btn { position: absolute; top: 20px; right: 20px; background: var(--accent); border: none; padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; z-index: 1001; }
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: white; display: none; }
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 2000; display: none; }
        #close-splat { position: absolute; top: 20px; left: 20px; z-index: 2100; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer; }
        #chat-window { position: absolute; bottom: 20px; right: 20px; width: 320px; height: 400px; background: var(--glass); border-radius: 15px; border: 1px solid #333; display: flex; flex-direction: column; z-index: 2100; box-shadow: 0 12px 40px rgba(0,0,0,0.6); overflow: hidden; }
        #chat-msgs { flex: 1; padding: 12px; overflow-y: auto; font-size: 0.85em; color: #eee; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 14px; border-radius: 12px; max-width: 85%; }
        .msg-agent { background: var(--accent); align-self: flex-start; }
        .msg-user { background: #333; align-self: flex-end; }
        #chat-input-wrap { display: flex; border-top: 1px solid #333; padding: 10px; background: rgba(0,0,0,0.3); }
        #chat-input { flex: 1; background: transparent; border: none; color: white; outline: none; }
        #modal-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; z-index: 3000; pointer-events: auto; }
        .modal-box { background: #151525; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; color: white; border: 1px solid #333; }
        input, textarea { width: 100%; box-sizing: border-box; background: #050510; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; margin: 10px 0; }
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; color: white; z-index: 2050; }
    </style>
    <script type="importmap">{ "imports": { 
        "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
        "@huggingface/hub": "https://cdn.jsdelivr.net/npm/@huggingface/hub@0.15.1/+esm" 
    }}</script>
</head>
<body>
    <div id="map-background"></div>
    <div id="splat-viewer" class="pointer-auto">
        <div id="loading-overlay">ğŸš€ æ­£åœ¨å»ºç«‹å…¨æ¯è¿æ¥...</div>
        <button id="close-splat">â† è¿”å›åœ°å›¾</button>
        <div id="chat-window">
            <div id="gemini-config-ui" style="padding:20px; text-align:center;">
                <p style="color:var(--primary); font-size:0.9em;">ğŸ‘¤ æ¿€æ´» AI å¯¼è§ˆå‘˜</p>
                <input type="password" id="user-gemini-key" placeholder="Gemini API Key...">
                <button id="save-key-btn" style="background:var(--accent); color:white; border:none; padding:10px; width:100%; border-radius:8px; cursor:pointer;">å¼€å¯ AI å¯¹è¯</button>
            </div>
            <div id="chat-main-ui" style="display:none; flex-direction:column; height:100%;">
                <div id="chat-msgs"></div>
                <div id="chat-input-wrap">
                    <input type="text" id="chat-input" placeholder="æé—®...">
                    <button id="chat-send" style="background:none; border:none; color:var(--primary); cursor:pointer;">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <div id="ui-layer">
        <button id="upload-btn" class="pointer-auto">+ æ–°å¢ä»»åŠ¡</button>
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title" style="margin:0"></h3>
            <p id="loc-desc" style="color:#aaa; font-size:0.85em; margin:10px 0;"></p>
            <div style="display:flex; justify-content:space-between; gap:10px;">
                <button id="del-btn" style="background:var(--danger); border:none; padding:8px 15px; border-radius:10px; color:white; cursor:pointer; font-weight:bold;">åˆ é™¤</button>
                <button id="enter-btn" style="background:var(--primary); border:none; padding:10px 25px; border-radius:20px; cursor:pointer; font-weight:bold; color:#000;">å…¨æ¯æŸ¥çœ‹</button>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-box">
            <h3 style="margin:0 0 15px 0">åˆ›å»ºé‡å»ºä»»åŠ¡</h3>
            <input type="password" id="hf-token" placeholder="Hugging Face Write Token">
            <input type="text" id="loc-name" placeholder="åœ°ç‚¹åç§°">
            <div style="display:flex; gap:8px;">
                <input type="text" id="lat-lon" readonly placeholder="ç‚¹å‡»åœ°å›¾æ‹¾å–åæ ‡">
                <button id="pick-btn" style="background:var(--accent); border:none; padding:0 15px; border-radius:8px; color:white; cursor:pointer;">æ‹¾å–</button>
            </div>
            <input type="file" id="photo-input" accept="image/*">
            <textarea id="desc-input" rows="2" placeholder="è¯·è¾“å…¥æè¿°..."></textarea>
            <button id="submit-btn" style="width:100%; background:var(--primary); border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:10px;">ä¸Šä¼ ä»»åŠ¡</button>
            <button onclick="document.getElementById('modal-overlay').style.display='none'" style="width:100%; background:none; border:none; color:#888; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <script type="module">
        import { commit } from '@huggingface/hub';
        import * as THREE from 'three';
        import * as GaussianSplats3D from 'https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js';

        const REPO_ID = "ColinWong24/my-gaussian-world";
        const state = { locations: [], currentLoc: null, viewer: null, isPicking: false, selectedCoords: null };

        // 1. åˆå§‹åŒ–åœ°å›¾
        const map = L.map('map-background', { center: [22.3193, 114.1694], zoom: 13, zoomControl: false });
        // ä½¿ç”¨æ›´ç¨³å®šçš„åœ°å›¾åˆ‡ç‰‡æº
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);

        // 2. æ•°æ®åŠ è½½ï¼ˆå¸¦å®¹é”™ï¼‰
        async function loadLocations() {
            try {
                const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
                if(!res.ok) throw new Error("Fetch Failed");
                state.locations = await res.json();
                markerGroup.clearLayers();
                state.locations.forEach(loc => {
                    const ready = loc.status === 'ready';
                    L.circleMarker([loc.lat, loc.lon], { radius: 10, fillColor: ready ? '#00ff88' : '#ffcc00', fillOpacity: 0.8, color: '#fff', weight: 2 })
                    .addTo(markerGroup).on('click', () => {
                        state.currentLoc = loc;
                        document.getElementById('loc-title').innerText = loc.name;
                        document.getElementById('loc-desc').innerText = loc.desc || "å¤„ç†ä¸­...";
                        document.getElementById('info-bar').style.display = 'block';
                        document.getElementById('enter-btn').disabled = !ready;
                        document.getElementById('enter-btn').style.opacity = ready ? "1" : "0.5";
                    });
                });
            } catch(e) { console.warn("æ•°æ®åŒæ­¥æš‚æœªè¿æ¥ï¼Œæ­£åœ¨é‡è¯•..."); }
        }

        // 3. 3D æ¸²æŸ“é€»è¾‘ï¼ˆæ ¸å¿ƒä¿®å¤ç‚¹ï¼‰
        document.getElementById('enter-btn').onclick = async () => {
            const container = document.getElementById('splat-viewer');
            const loader = document.getElementById('loading-overlay');
            container.style.display = 'block';
            loader.style.display = 'flex';

            if (state.viewer) { state.viewer.dispose(); state.viewer = null; }

            state.viewer = new GaussianSplats3D.Viewer({
                rootElement: container,
                cameraUp: [0, -1, 0],
                sharedMemoryForWorkers: false, // é’ˆå¯¹ GitHub Pages å®‰å…¨é™åˆ¶
                webWorkerCount: 0,             // é’ˆå¯¹ GitHub Pages æŠ¥é”™
                showSceneStatePlaceholder: false
            });

            await state.viewer.init();
            
            // æ‹¼æ¥ URL å¢åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.currentLoc.splatPath}?t=${Date.now()}`;
            
            try {
                await state.viewer.addSplatScene(url, {
                    'format': 'ply', // é‡è¦ï¼šæ˜¾å¼æŒ‡å®š PLY æ ¼å¼ï¼Œè§£å†³ URL å‚æ•°å¯¼è‡´çš„è¯†åˆ«æŠ¥é”™
                    'onSceneLoad': (scene) => {
                        loader.style.display = 'none';
                        const mesh = scene.object3D;
                        mesh.rotation.y = Math.PI;
                        const box = new THREE.Box3().setFromObject(mesh);
                        mesh.position.sub(box.getCenter(new THREE.Vector3()));
                    }
                });
                state.viewer.start();
            } catch (err) { 
                console.error("æ¸²æŸ“å¼‚å¸¸", err); 
                loader.style.display = 'none'; 
                alert("æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æ–‡ä»¶æ ¼å¼ã€‚");
            }
        };

        // 4. åˆ é™¤é€»è¾‘
        document.getElementById('del-btn').onclick = async () => {
            const token = prompt("è¯·è¾“å…¥ HF Write Tokenï¼š");
            if (!token || !confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) return;
            const operations = [
                { operation: "delete", path: state.currentLoc.photoPath },
                { operation: "addOrUpdate", path: "locations.json", content: new Blob([JSON.stringify(state.locations.filter(l => l.id !== state.currentLoc.id), null, 2)], {type:"application/json"}) }
            ];
            if (state.currentLoc.splatPath) operations.push({ operation: "delete", path: state.currentLoc.splatPath });
            try {
                await commit({ credentials: { accessToken: token }, repo: { type: "dataset", name: REPO_ID }, title: "Delete task", operations });
                location.reload();
            } catch (e) { alert("æ“ä½œå¤±è´¥"); }
        };

        // 5. äº¤äº’é€»è¾‘
        document.getElementById('upload-btn').onclick = () => document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('pick-btn').onclick = () => { document.getElementById('modal-overlay').style.display = 'none'; state.isPicking = true; };
        map.on('click', (e) => {
            if (state.isPicking) {
                state.selectedCoords = e.latlng;
                document.getElementById('lat-lon').value = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                state.isPicking = false;
                document.getElementById('modal-overlay').style.display = 'flex';
            }
        });
        document.getElementById('close-splat').onclick = () => {
            document.getElementById('splat-viewer').style.display = 'none';
            if (state.viewer) { state.viewer.stop(); state.viewer.dispose(); state.viewer = null; }
        };
        document.getElementById('save-key-btn').onclick = () => {
            const key = document.getElementById('user-gemini-key').value.trim();
            if (key) { localStorage.setItem('MY_GEMINI_KEY', key); document.getElementById('gemini-config-ui').style.display = 'none'; document.getElementById('chat-main-ui').style.display = 'flex'; }
        };

        loadLocations();
        setInterval(loadLocations, 15000); // é™ä½åŒæ­¥é¢‘ç‡
    </script>
</body>
</html>
