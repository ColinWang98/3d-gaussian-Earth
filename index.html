<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Hub | Pro Holographic Map</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
    <style>
        :root { --primary: #00ff88; --danger: #ff4444; --glass: rgba(10, 15, 30, 0.95); --accent: #0072ff; }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; }
        #map-background { position: absolute; inset: 0; z-index: 1; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }
        
        #btn-group { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1001; }
        .control-btn { background: var(--glass); color: white; border: 1px solid #444; padding: 10px 18px; border-radius: 20px; cursor: pointer; pointer-events: auto; font-size: 0.9em; }
        
        #upload-btn { position: absolute; top: 20px; right: 20px; background: var(--accent); border: none; padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; z-index: 1001; pointer-events: auto; }
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: white; display: none; }
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 2000; display: none; }
        #close-splat { position: absolute; top: 20px; left: 20px; z-index: 2100; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer; }
        
        #loading-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; color: white; z-index: 2050; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-left-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
    <script type="importmap">{ "imports": { 
        "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js"
    }}</script>
</head>
<body>
    <div id="map-background"></div>

    <div id="splat-viewer" class="pointer-auto">
        <div id="loading-overlay">
            <div class="spinner"></div>
            <div id="loading-status">ğŸš€ æ­£åœ¨å¼ºåˆ¶åŠ è½½ PLY 3DGS æ¨¡å‹...</div>
            <small style="opacity: 0.6; margin-top: 10px;">é€šè¿‡æšä¸¾å¼ºåˆ¶æŒ‡å®šè§£æè·¯å¾„</small>
        </div>
        <button id="close-splat">â† è¿”å›åœ°å›¾</button>
    </div>

    <div id="ui-layer">
        <div id="btn-group">
            <button id="style-toggle" class="control-btn">ğŸŒ™ æ·±è‰²é£æ ¼</button>
        </div>
        <button id="upload-btn">+ æ–°å¢ä»»åŠ¡</button>
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title" style="margin:0"></h3>
            <p id="loc-desc" style="color:#aaa; font-size:0.85em; margin:10px 0;"></p>
            <button id="enter-btn" style="width:100%; background:var(--primary); border:none; padding:12px; border-radius:20px; cursor:pointer; font-weight:bold; color:#000;">è¿›å…¥å…¨æ¯å½±åƒ</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <script type="module">
        import * as THREE from 'three';
        import * as GaussianSplats3D from 'https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js';

        const REPO_ID = "ColinWong24/my-gaussian-world";
        const state = { locations: [], currentLoc: null, viewer: null };

        // 1. åœ°å›¾åˆå§‹åŒ– [web:122]
        const map = L.map('map-background', { center: [22.3193, 114.1694], zoom: 13, zoomControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);

        async function loadLocations() {
            try {
                const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
                state.locations = await res.json();
                markerGroup.clearLayers();
                state.locations.forEach(loc => {
                    const ready = loc.status === 'ready';
                    L.circleMarker([loc.lat, loc.lon], { 
                        radius: 10, fillColor: ready ? '#00ff88' : '#666', 
                        fillOpacity: 0.8, color: '#fff', weight: 2 
                    }).addTo(markerGroup).on('click', () => {
                        state.currentLoc = loc;
                        document.getElementById('loc-title').innerText = loc.name;
                        document.getElementById('loc-desc').innerText = loc.desc || "å¤„ç†ä¸­...";
                        document.getElementById('info-bar').style.display = 'block';
                        document.getElementById('enter-btn').disabled = !ready;
                        document.getElementById('enter-btn').style.opacity = ready ? "1" : "0.5";
                    });
                });
            } catch(e) { console.warn("Syncing..."); }
        }

        // PLY æ–‡ä»¶éªŒè¯å‡½æ•°
        async function validatePlyFile(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                if (!response.ok) {
                    throw new Error(`æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: ${response.status}`);
                }
                const contentLength = response.headers.get('content-length');
                if (contentLength && parseInt(contentLength) < 100) {
                    throw new Error('æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ PLY æ–‡ä»¶');
                }
                
                // è·å–æ–‡ä»¶å¤´éƒ¨è¿›è¡ŒéªŒè¯
                const headResponse = await fetch(url, { 
                    headers: { 'Range': 'bytes=0-1023' } 
                });
                const headText = await headResponse.text();
                
                // æ£€æŸ¥ PLY æ–‡ä»¶å¤´
                if (!headText.startsWith('ply') && !headText.startsWith('PLY')) {
                    throw new Error('æ–‡ä»¶ä¸æ˜¯æœ‰æ•ˆçš„ PLY æ ¼å¼ï¼ˆç¼ºå°‘ PLY å¤´éƒ¨æ ‡è¯†ï¼‰');
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„ 3DGS å­—æ®µ
                const requiredFields = ['x', 'y', 'z', 'f_dc_0', 'f_dc_1', 'f_dc_2'];
                const hasRequiredFields = requiredFields.some(field => headText.includes(field));
                if (!hasRequiredFields) {
                    console.warn('è­¦å‘Š: PLY æ–‡ä»¶å¯èƒ½ä¸åŒ…å«æ ‡å‡† 3DGS å­—æ®µ');
                }
                
                return true;
            } catch (err) {
                console.error('PLY æ–‡ä»¶éªŒè¯å¤±è´¥:', err);
                throw err;
            }
        }

        // 2. ç»ˆææ¸²æŸ“æ–¹æ¡ˆï¼šå¼ºåˆ¶ format å£°æ˜ [web:1][web:10]
        document.getElementById('enter-btn').onclick = async () => {
            if (!state.currentLoc) return;
            const container = document.getElementById('splat-viewer');
            const loader = document.getElementById('loading-overlay');
            container.style.display = 'block';
            loader.style.display = 'flex';

            // æ¸…ç†æ—§è§†å›¾
            if (state.viewer) { state.viewer.dispose(); state.viewer = null; }

            // åˆå§‹åŒ–æ–°è§†å›¾
            state.viewer = new GaussianSplats3D.Viewer({
                rootElement: container,
                cameraUp: [0, -1, 0],
                sharedMemoryForWorkers: false,
                webWorkerCount: 0,
                showSceneStatePlaceholder: false
            });

            await state.viewer.init();

            const rawUrl = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.currentLoc.splatPath}?t=${Date.now()}`;
            
            try {
                // å…ˆéªŒè¯æ–‡ä»¶
                const statusEl = document.getElementById('loading-status');
                if (statusEl) statusEl.innerText = 'ğŸ” æ­£åœ¨éªŒè¯ PLY æ–‡ä»¶æ ¼å¼...';
                await validatePlyFile(rawUrl);
                
                if (statusEl) statusEl.innerText = 'ğŸš€ æ­£åœ¨åŠ è½½ PLY 3DGS æ¨¡å‹...';
                
                // å…³é”®ç‚¹ 1ï¼šformat: 1 å¼ºåˆ¶å°† URL è¯†åˆ«ä¸º PLY æ ¼å¼ï¼Œè·³è¿‡åç¼€åå’Œå¤´éƒ¨çŒœæµ‹ [web:1]
                // å…³é”®ç‚¹ 2ï¼šprogressiveLoad: false é¿å…æµå¼åŠ è½½ä¸­çš„æ•°æ®å†²çª
                await state.viewer.addSplatScene(rawUrl, {
                    'format': 1, // GaussianSplats3D.SceneFormat.Ply
                    'showLoadingUI': false,
                    'progressiveLoad': false,
                    'onSceneLoad': () => {
                        loader.style.display = 'none';
                        state.viewer.start();
                    }
                });

                // è‡ªåŠ¨å±…ä¸­
                setTimeout(() => {
                    const mesh = state.viewer.getSplatMesh();
                    if (mesh) {
                        const box = new THREE.Box3().setFromObject(mesh);
                        mesh.position.sub(box.getCenter(new THREE.Vector3()));
                    }
                }, 100);

            } catch (err) {
                console.error("æ¸²æŸ“å¼•æ“æ‹¦æˆª:", err);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ•°ç»„é•¿åº¦é”™è¯¯
                if (err.message && err.message.includes('Invalid typed array length')) {
                    loader.style.display = 'none';
                    alert(`æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šPLY æ–‡ä»¶å¤´è§£æå¤±è´¥ï¼Œå¯èƒ½æ˜¯æ–‡ä»¶æŸåæˆ–æ ¼å¼ä¸æ­£ç¡®ã€‚\n\né”™è¯¯è¯¦æƒ…: ${err.message}\n\nè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å®Œæ•´ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜é‡æ–°ç”Ÿæˆæ¨¡å‹ã€‚`);
                    return;
                }
                
                // æ–¹æ¡ˆ Bï¼šå¦‚æœ addSplatScene ä¾ç„¶å¤±è´¥ï¼Œå°è¯•ç›´æ¥è°ƒç”¨åº•å±‚ PlyLoader é™æ€æ–¹æ³• [web:9]
                try {
                    console.log("å°è¯•å¤‡é€‰è·¯å¾„: Static PlyLoader...");
                    const statusEl = document.getElementById('loading-status');
                    if (statusEl) statusEl.innerText = 'ğŸ”„ å°è¯•å¤‡é€‰åŠ è½½æ–¹å¼...';
                    const splatBuffer = await GaussianSplats3D.PlyLoader.loadFromURL(rawUrl);
                    await state.viewer.addSplatBuffers([splatBuffer], [{}]);
                    loader.style.display = 'none';
                    state.viewer.start();
                } catch (fail) {
                    console.error("å¤‡é€‰æ–¹æ¡ˆä¹Ÿå¤±è´¥:", fail);
                    loader.style.display = 'none';
                    const errorMsg = fail.message && fail.message.includes('Invalid typed array length')
                        ? `æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼šPLY æ–‡ä»¶å¤´è§£æå¤±è´¥ã€‚\n\nå¯èƒ½åŸå› ï¼š\n1. æ–‡ä»¶æŸåæˆ–ä¸å®Œæ•´\n2. æ–‡ä»¶æ ¼å¼ä¸ç¬¦åˆæ ‡å‡† 3DGS PLY æ ¼å¼\n3. æ–‡ä»¶å¤´ä¸­çš„æ•°å€¼è§£æé”™è¯¯\n\né”™è¯¯: ${fail.message}`
                        : `æ¨¡å‹è§£æå¤±è´¥ï¼šæ–‡ä»¶è™½ç„¶æœ‰ .ply åç¼€ï¼Œä½†å…¶å†…éƒ¨äºŒè¿›åˆ¶ç»“æ„ä¸ç¬¦åˆæ ‡å‡† 3DGS æ ¼å¼ã€‚\n\né”™è¯¯: ${fail.message || fail}`;
                    alert(errorMsg);
                }
            }
        };

        document.getElementById('close-splat').onclick = () => {
            document.getElementById('splat-viewer').style.display = 'none';
            if (state.viewer) { state.viewer.stop(); state.viewer.dispose(); state.viewer = null; }
        };

        loadLocations();
    </script>
</body>
</html>
