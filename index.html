<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Tracker | äººè„¸è¿½è¸ªå…¨æ¯ç‰ˆ</title>
    <!-- 1. å¤–éƒ¨ä¾èµ–åº“å¼•ç”¨ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    
    <style>
        :root { --primary: #00ff88; --glass: rgba(10, 15, 30, 0.95); }
        body, html { margin: 0; padding: 0; height: 100%; background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        /* åœ°å›¾èƒŒæ™¯å±‚ */
        #map-background { position: absolute; inset: 0; z-index: 1; background: #050510; }
        
        /* UI äº¤äº’å±‚ */
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }
        
        #upload-btn { position: absolute; top: 20px; right: 20px; background: #0072ff; border: none; padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        #picker-toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #ffcc00; color: #000; font-weight: bold; padding: 10px 25px; border-radius: 30px; display: none; }
        
        /* é…ç½®å¼¹çª— */
        #modal-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-box { background: #151525; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; color: white; border: 1px solid #333; }
        input, textarea { width: 100%; box-sizing: border-box; background: #050510; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; margin: 8px 0; }
        
        /* ä¿¡æ¯æ¡ */
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); color: white; display: none; }
        
        /* 3D æ²‰æµ¸è§†å›¾ [web:208] */
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 2000; display: none; }
        #close-splat { position: absolute; top: 20px; left: 20px; z-index: 2100; padding: 10px 20px; border-radius: 20px; background: rgba(255,255,255,0.2); color: white; border: 1px solid white; cursor: pointer; }
        #tracking-status { position: absolute; top: 20px; right: 20px; z-index: 2100; color: var(--primary); font-size: 0.8em; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 10px; display: none; }
    </style>
    
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "@huggingface/hub": "https://cdn.jsdelivr.net/npm/@huggingface/hub@0.15.1/+esm"
        }
    }
    </script>
</head>
<body>
    <div id="map-background"></div>
    <div id="picker-toast">ğŸ“ è¯·ç‚¹å‡»åœ°å›¾æ‹¾å–åæ ‡ç‚¹...</div>
    
    <div id="splat-viewer" class="pointer-auto">
        <div id="tracking-status">ğŸ‘¤ äººè„¸è¿½è¸ªå·²æ¿€æ´»</div>
        <button id="close-splat">â† è¿”å›åœ°å›¾</button>
    </div>

    <div id="ui-layer">
        <button id="upload-btn" class="pointer-auto">+ æ–°å¢é‡å»ºä»»åŠ¡</button>
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title" style="margin:0">é¦™æ¸¯æ‰«æç‚¹</h3>
            <p id="loc-status" style="color:#ffcc00; font-size:0.85em; margin:5px 0;"></p>
            <p id="loc-desc" style="color:#aaa; font-size:0.9em;"></p>
            <button id="enter-btn" style="background:#00ff88; border:none; padding:10px 20px; border-radius:20px; font-weight:bold; float:right; cursor:pointer; color:#000;">å¼€å¯å…¨æ¯æŸ¥çœ‹</button>
        </div>

        <div id="modal-overlay" class="pointer-auto">
            <div class="modal-box">
                <h3 style="margin-top:0">ä»»åŠ¡é…ç½®</h3>
                <label>HF Write Token</label><input type="password" id="hf-token">
                <label>åæ ‡æ‹¾å–</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" id="lat-lon-display" readonly placeholder="ç‚¹å‡»æ‹¾å–æŒ‰é’®...">
                    <button id="picker-btn" style="background:#0072ff; color:white; border:none; border-radius:8px; padding:0 15px; cursor:pointer;">ğŸ“ æ‹¾å–</button>
                </div>
                <label>é€‰æ‹©å›¾ç‰‡</label><input type="file" id="photo" accept="image/*">
                <label>ä»»åŠ¡æè¿°</label><textarea id="desc" rows="2"></textarea>
                <button id="submit-btn" style="width:100%; background:#00ff88; padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; color:#000;">æäº¤å¹¶åŒæ­¥</button>
                <button id="cancel-btn" style="width:100%; background:none; color:#888; border:none; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { commit } from '@huggingface/hub';
        import * as THREE from 'three';
        import * as GaussianSplats3D from 'https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js';

        const REPO_ID = "ColinWong24/my-gaussian-world";
        let state = { locations: [], currentLoc: null, isPicking: false, viewer: null, facePos: { x: 0, y: 0 } };

        // 1. åˆå§‹åŒ– 2D åœ°å›¾èƒŒæ™¯ [attached_file:1]
        const map = L.map('map-background', { center: [22.3193, 114.1694], zoom: 13, zoomControl: false });
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
        const markerGroup = L.layerGroup().addTo(map);

        map.on('click', (e) => {
            if (state.isPicking) {
                document.getElementById('lat-lon-display').value = `${e.latlng.lat.toFixed(5)}, ${e.latlng.lng.toFixed(5)}`;
                state.selectedCoords = e.latlng;
                state.isPicking = false;
                document.getElementById('picker-toast').style.display = 'none';
                document.getElementById('modal-overlay').style.display = 'flex';
            }
        });

        // 2. åˆå§‹åŒ–äººè„¸è¿½è¸ª [web:196][web:200]
        const faceMesh = new FaceMesh({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}` });
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        faceMesh.onResults((res) => {
            if (res.multiFaceLandmarks?.length > 0) {
                const nose = res.multiFaceLandmarks[0][1]; // é¼»å°–å…³é”®ç‚¹
                state.facePos.x = (nose.x - 0.5) * 2;
                state.facePos.y = (nose.y - 0.5) * 2;
                document.getElementById('tracking-status').style.display = 'block';
            }
        });

        async function startCamera() {
            const video = document.createElement('video');
            const camera = new Camera(video, { onFrame: async () => { await faceMesh.send({ image: video }); }, width: 640, height: 480 });
            camera.start();
        }

        // 3. æ•°æ®åŒæ­¥é€»è¾‘
        async function loadLocations() {
            try {
                const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
                state.locations = await res.json();
                markerGroup.clearLayers();
                state.locations.forEach(loc => {
                    const isReady = loc.status !== 'processing';
                    L.circleMarker([loc.lat, loc.lon], { radius: 10, fillColor: isReady ? '#00ff88' : '#ffcc00', fillOpacity: 0.9, weight: 2, color: '#fff' })
                    .addTo(markerGroup).on('click', () => {
                        state.currentLoc = loc;
                        document.getElementById('info-bar').style.display = 'block';
                        document.getElementById('loc-status').innerText = isReady ? "âœ… é‡å»ºå·²å®Œæˆ" : "âŒ› GPU æ­£åœ¨è®¡ç®—...";
                        document.getElementById('enter-btn').style.display = isReady ? "block" : "none";
                    });
                });
            } catch (e) {}
        }

        // 4. UI äº¤äº’é€»è¾‘
        document.getElementById('picker-btn').onclick = () => { document.getElementById('modal-overlay').style.display = 'none'; document.getElementById('picker-toast').style.display = 'block'; state.isPicking = true; };
        document.getElementById('upload-btn').onclick = () => document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('cancel-btn').onclick = () => document.getElementById('modal-overlay').style.display = 'none';

        document.getElementById('enter-btn').onclick = async () => {
            if (!state.currentLoc || state.currentLoc.status === 'processing') return;
            const container = document.getElementById('splat-viewer');
            container.style.display = 'block';
            startCamera(); // å¯åŠ¨å…¨æ¯è¿½è¸ª

            const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.currentLoc.splatPath}`;
            try {
                if (!state.viewer) {
                    state.viewer = new GaussianSplats3D.Viewer({ 
                        'rootElement': container, 'cameraUp': [0, -1, 0], 
                        'initialCameraPosition': [0, 0, 5], 'sharedMemoryForWorkers': false 
                    });
                    const initP = state.viewer.init();
                    if (initP?.then) await initP;
                }
                await state.viewer.addSplatScene(url, { 'streamView': url.endsWith('.splat') });
                state.viewer.start();

                // å…¨æ¯éšåŠ¨å¾ªç¯ [web:204][web:208]
                const runParallax = () => {
                    if (container.style.display === 'block') {
                        requestAnimationFrame(runParallax);
                        const cam = state.viewer.camera;
                        const targetX = -state.facePos.x * 2.0; // è§†å·®å¹…åº¦
                        const targetY = -state.facePos.y * 2.0;
                        cam.position.x += (targetX - cam.position.x) * 0.1; // å¹³æ»‘æ’å€¼
                        cam.position.y += (targetY - cam.position.y) * 0.1;
                        cam.lookAt(0, 0, 0); // å§‹ç»ˆæ³¨è§†æ¨¡å‹ä¸­å¿ƒ
                    }
                };
                runParallax();
            } catch (e) { console.error(e); }
        };

        document.getElementById('close-splat').onclick = () => document.getElementById('splat-viewer').style.display = 'none';
        loadLocations();
        setInterval(loadLocations, 10000);
    </script>
</body>
</html>
