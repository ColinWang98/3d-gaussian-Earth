<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Explorer | Leaflet ç‰ˆ</title>
    <!-- å¼•å…¥ Leaflet æ ·å¼ä¸è„šæœ¬ -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #00ff88; --processing: #ffcc00; --glass: rgba(10, 15, 30, 0.95); }
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        
        /* åœ°å›¾å æ»¡å…¨å± */
        #map { position: absolute; inset: 0; z-index: 1; background: #050510; }
        
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 1000; }
        .pointer-auto { pointer-events: auto; }
        
        /* UI æŒ‰é’® */
        #upload-btn { position: absolute; top: 20px; right: 20px; background: linear-gradient(135deg, #00c6ff, #0072ff); border: none; padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; }
        #picker-toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 200, 0, 0.95); color: black; font-weight: bold; padding: 10px 25px; border-radius: 30px; display: none; }
        
        /* å¼¹çª— */
        #modal-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
        .modal-box { background: #151525; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; color: white; }
        .input-group { margin-bottom: 15px; }
        input, textarea { width: 100%; box-sizing: border-box; background: #050510; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; margin-top: 5px; }
        
        /* ä¿¡æ¯æ¡ */
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 480px; background: var(--glass); padding: 20px; border-radius: 20px; color: white; display: none; }
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 2000; display: none; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="picker-toast">ğŸ“ è¯·ç›´æ¥åœ¨åœ°å›¾ä¸Šç‚¹å‡»ä½ç½®...</div>
    <div id="splat-viewer" class="pointer-auto"><button id="close-splat" style="position:absolute;top:20px;left:20px;z-index:2100;padding:10px;">â† è¿”å›åœ°å›¾</button></div>

    <div id="ui-layer">
        <button id="upload-btn" class="pointer-auto">+ æ–°å¢ä»»åŠ¡</button>
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title" style="margin:0">é¦™æ¸¯è®°å¿†ç‚¹</h3>
            <p id="loc-status" style="color:var(--processing); font-size:0.85em; margin:5px 0;"></p>
            <p id="loc-desc" style="color:#aaa; font-size:0.9em;"></p>
            <button id="enter-btn" style="background:var(--primary);border:none;padding:10px 20px;border-radius:20px;font-weight:bold;float:right;margin-top:-30px;cursor:pointer;">æŸ¥çœ‹ 3D</button>
        </div>

        <div id="modal-overlay" class="pointer-auto">
            <div class="modal-box">
                <h3>é…ç½® 3DGS ä»»åŠ¡</h3>
                <div class="input-group"><label>HF Token</label><input type="password" id="hf-token"></div>
                <div class="input-group">
                    <label>åœ°ç†ä½ç½®</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="lat-lon-display" readonly placeholder="ç‚¹å‡»å³ä¾§æŒ‰é’®é€‰æ‹©...">
                        <button id="picker-btn" style="background:#0072ff; color:white; border:none; border-radius:8px; padding:0 10px; cursor:pointer;">ğŸ“ æ‹¾å–</button>
                    </div>
                </div>
                <div class="input-group"><label>ä¸Šä¼ å›¾ç‰‡</label><input type="file" id="photo"></div>
                <div class="input-group"><label>æè¿°</label><textarea id="desc" rows="3"></textarea></div>
                <button id="submit-btn" style="width:100%; background:var(--primary); padding:12px; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">æäº¤</button>
                <button id="cancel-btn" style="width:100%; background:none; color:#888; border:none; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { commit } from '@huggingface/hub';
        import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';

        const REPO_ID = "ColinWong24/my-gaussian-world";
        let state = { locations: [], currentLoc: null, isPicking: false, viewer: null };

        // 1. åˆå§‹åŒ– Leaflet åœ°å›¾ [attached_file:1]
        const map = L.map('map', {
            center: [22.3193, 114.1694], // é¦™æ¸¯ä¸­å¿ƒ
            zoom: 13,
            zoomControl: false
        });

        // åŠ è½½ OpenStreetMap ç“¦ç‰‡ [attached_file:1]
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);

        const markerGroup = L.layerGroup().addTo(map);

        // 2. åæ ‡æ‹¾å–é€»è¾‘ï¼šç›´æ¥é€šè¿‡ map.on('click') è·å– latlng [attached_file:1]
        map.on('click', (e) => {
            if (state.isPicking) {
                const { lat, lng } = e.latlng;
                document.getElementById('lat-lon-display').value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
                state.selectedCoords = { lat, lng };
                state.isPicking = false;
                document.getElementById('picker-toast').style.display = 'none';
                document.getElementById('modal-overlay').style.display = 'flex';
            }
        });

        // 3. æ•°æ®åŠ è½½ä¸ Marker æ¸²æŸ“
        async function loadLocations() {
            try {
                const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
                state.locations = await res.json();
                markerGroup.clearLayers();
                state.locations.forEach(loc => {
                    const isReady = loc.status !== 'processing';
                    // ä½¿ç”¨ Leaflet CircleMarker ä»£æ›¿çƒä½“ [attached_file:1]
                    const marker = L.circleMarker([loc.lat, loc.lon], {
                        radius: 10,
                        fillColor: isReady ? '#00ff88' : '#ffcc00',
                        color: "#fff",
                        weight: 2,
                        fillOpacity: 0.8
                    }).addTo(markerGroup);

                    marker.on('click', () => {
                        state.currentLoc = loc;
                        document.getElementById('info-bar').style.display = 'block';
                        document.getElementById('loc-desc').innerText = loc.desc;
                        document.getElementById('loc-status').innerText = isReady ? 'âœ… æ¨¡å‹å·²å°±ç»ª' : 'âŒ› æ­£åœ¨é‡å»ºä¸­...';
                    });
                });
            } catch (e) {}
        }

        // 4. äº‹ä»¶ç»‘å®š
        document.getElementById('upload-btn').onclick = () => document.getElementById('modal-overlay').style.display = 'flex';
        document.getElementById('cancel-btn').onclick = () => document.getElementById('modal-overlay').style.display = 'none';
        document.getElementById('picker-btn').onclick = () => {
            document.getElementById('modal-overlay').style.display = 'none';
            document.getElementById('picker-toast').style.display = 'block';
            state.isPicking = true;
        };
        document.getElementById('enter-btn').onclick = () => {
            if (state.currentLoc && state.currentLoc.status !== 'processing') {
                document.getElementById('splat-viewer').style.display = 'block';
                const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.currentLoc.splatPath}`;
                if (!state.viewer) {
                    state.viewer = new GaussianSplats3D.Viewer({ 
                        'rootElement': document.getElementById('splat-viewer') 
                    });
                    state.viewer.init();
                }
                state.viewer.addSplatScene(url, { 'streamView': true }).then(() => state.viewer.start());
            }
        };
        document.getElementById('close-splat').onclick = () => document.getElementById('splat-viewer').style.display = 'none';

        loadLocations();
    </script>
</body>
</html>
