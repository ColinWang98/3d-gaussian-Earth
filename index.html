<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HK 3DGS Explorer | åŠ¨æ€åœ°å›¾ç‰ˆ</title>
    <style>
        :root { --primary: #00ff88; --processing: #ffcc00; --glass: rgba(10, 15, 30, 0.95); }
        body { margin: 0; overflow: hidden; background: #050510; font-family: 'Segoe UI', system-ui, sans-serif; color: white; }
        #canvas-container { position: absolute; inset: 0; z-index: 1; }
        #ui-layer { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .pointer-auto { pointer-events: auto; }
        
        /* UI æŒ‰é’® */
        #upload-btn { position: absolute; top: 20px; right: 20px; background: linear-gradient(135deg, #00c6ff, #0072ff); border: none; padding: 12px 24px; border-radius: 50px; color: white; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(0,114,255,0.4); }
        #picker-toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 200, 0, 0.95); color: black; font-weight: bold; padding: 10px 25px; border-radius: 30px; display: none; z-index: 100; }
        
        /* å¼¹çª—æ ·å¼ */
        #modal-overlay { display: none; position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 100; justify-content: center; align-items: center; }
        .modal-box { background: #151525; padding: 25px; border-radius: 16px; width: 90%; max-width: 400px; border: 1px solid #333; pointer-events: auto; }
        .input-group { margin-bottom: 15px; }
        input, textarea { width: 100%; box-sizing: border-box; background: #050510; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; }
        .btn-submit { width: 100%; background: var(--primary); color: black; border:none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* ä¿¡æ¯æ¡ */
        #info-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 480px; background: var(--glass); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); display: none; }
        #splat-viewer { position: absolute; inset: 0; background: #000; z-index: 50; display: none; }
    </style>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/",
            "geo-three": "https://cdn.jsdelivr.net/npm/geo-three@0.0.11/build/geo-three.module.js",
            "@mkkellogg/gaussian-splats-3d": "https://cdn.jsdelivr.net/npm/@mkkellogg/gaussian-splats-3d@0.4.6/build/gaussian-splats-3d.module.js",
            "@huggingface/hub": "https://cdn.jsdelivr.net/npm/@huggingface/hub@0.15.1/+esm"
        }
    }
    </script>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="picker-toast">ğŸ“ è¯·ç‚¹å‡»åœ°å›¾é€‰æ‹©ç‚¹ä½...</div>
    <div id="splat-viewer" class="pointer-auto"><button id="close-splat" style="position:absolute;top:20px;left:20px;z-index:60;padding:10px;">â† è¿”å›åœ°å›¾</button></div>

    <div id="ui-layer">
        <button id="upload-btn" class="pointer-auto">+ æ–°å¢ä»»åŠ¡</button>
        <div id="info-bar" class="pointer-auto">
            <h3 id="loc-title" style="margin:0">é¦™æ¸¯è®°å¿†ç‚¹</h3>
            <p id="loc-status" style="color:var(--processing); font-size:0.85em; margin:5px 0;"></p>
            <p id="loc-desc" style="color:#aaa; font-size:0.9em;"></p>
            <button id="enter-btn" style="background:var(--primary);border:none;padding:10px 20px;border-radius:20px;font-weight:bold;float:right;margin-top:-30px;cursor:pointer;">è¿›å…¥ 3D</button>
        </div>

        <div id="modal-overlay" class="pointer-auto">
            <div class="modal-box">
                <h3 style="margin-top:0">é…ç½® 3DGS ä»»åŠ¡</h3>
                <div class="input-group"><label>HF Token</label><input type="password" id="hf-token"></div>
                <div class="input-group">
                    <label>åœ°ç†ä½ç½®</label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="lat-lon-display" readonly placeholder="ç‚¹å‡»æ‹¾å–ä½ç½®..." style="flex:1; background:#111;">
                        <button id="picker-btn" style="background:#0072ff; color:white; border:none; border-radius:8px; padding:0 15px; cursor:pointer;">ğŸ“ æ‹¾å–</button>
                    </div>
                </div>
                <div class="input-group"><label>è¾“å…¥å›¾ç‰‡</label><input type="file" id="photo"></div>
                <div class="input-group"><label>æè¿°</label><textarea id="desc" rows="3"></textarea></div>
                <button id="submit-btn" class="btn-submit">æäº¤è‡³ GPU</button>
                <button id="cancel-btn" style="width:100%; background:none; color:#888; border:none; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as GEOTHREE from 'geo-three';
        import * as GaussianSplats3D from '@mkkellogg/gaussian-splats-3d';
        import { commit } from '@huggingface/hub';

        const REPO_ID = "ColinWong24/my-gaussian-world"; 
        const state = { locations: [], currentLoc: null, viewer: null, isPicking: false, selectedCoords: null };

        // æå‰å£°æ˜ UI ç®¡ç†å™¨ï¼Œé˜²æ­¢å¼‚æ­¥åŠ è½½æ—¶å˜é‡ä¸¢å¤±
        const UI = {
            showUpload: (show) => document.getElementById('modal-overlay').style.display = show ? 'flex' : 'none',
            showToast: (show) => document.getElementById('picker-toast').style.display = show ? 'block' : 'none'
        };

        const App = {
            init: async function() {
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 10, 1e7);
                this.camera.position.set(0, 30000, 30000); // æŠ¬é«˜åˆå§‹è§†è§’
                
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.setClearColor(0x050515); // ç¡®ä¿éçº¯é»‘
                document.getElementById('canvas-container').appendChild(this.renderer.domElement);
                
                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;

                // åŠ¨æ€åœ°å›¾äº¤äº’ï¼šä½¿ç”¨ geo-three çš„ MapView å®ç°å…¨æ¸¯èŒƒå›´ 3D åœ°å›¾
                // ä½¿ç”¨ SPHERICAL æ¨¡å¼æ„å»ºçœŸå®åœ°çƒ
                const provider = new GEOTHREE.OpenStreetMapsProvider();
                this.map = new GEOTHREE.MapView(GEOTHREE.MapView.SPHERICAL, provider);
                
                // 3D åœ°çƒæ¨¡å¼ä¸‹ï¼Œæ— éœ€ç§»åŠ¨åœ°å›¾æœ¬èº«ï¼Œè€Œæ˜¯è°ƒæ•´ç›¸æœºä½ç½®
                this.scene.add(this.map);

                // é¦™æ¸¯åæ ‡ (22.3193Â°N, 114.1694Â°E)
                // å°†ç»çº¬åº¦è½¬æ¢ä¸º 3D çƒé¢åæ ‡ (é»˜è®¤åœ°çƒåŠå¾„ 6378137 ç±³)
                // geo-three å†…éƒ¨å¤„ç†äº†å•ä½ï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®—ç›¸æœºåº”è¯¥åœ¨çš„ä½ç½®
                const coords = GEOTHREE.UnitsUtils.datumsToSpherical(22.3193, 114.1694);
                
                // ç›¸æœºä½ç½®ï¼šåœ¨é¦™æ¸¯ä¸Šæ–¹çš„é«˜ç©º
                // ç¨å¾®åç§»ä¸€ç‚¹ä»¥äº§ç”Ÿä¿¯è§†æ•ˆæœ
                const height = 10000; // 10km é«˜ç©º
                const scale = 1.0; // ç¼©æ”¾ç³»æ•°ï¼Œè§† geo-three å†…éƒ¨å®ç°è€Œå®šï¼Œé€šå¸¸æ˜¯ 1å•ä½=1ç±³
                
                // æ³¨æ„ï¼šgeo-three çš„ spherical æ¨¡å¼ï¼Œåœ°çƒä¸­å¿ƒåœ¨ (0,0,0)
                // datumsToSpherical è¿”å›çš„æ˜¯å½’ä¸€åŒ–å‘é‡è¿˜æ˜¯å®é™…åæ ‡ï¼Ÿ
                // æŸ¥çœ‹æºç æˆ–æ–‡æ¡£ï¼Œé€šå¸¸ datumsToSpherical(lat, lon) è¿”å› {x, y, z}
                
                // é‡æ–°è®¡ç®—ç›¸æœºä½ç½®ï¼šæ²¿ç€è¯¥ç»çº¬åº¦çš„æ³•å‘é‡å‘å¤–å»¶ä¼¸
                // ç®€å•çš„çƒé¢åæ ‡å…¬å¼:
                // phi = (90 - lat) * (Math.PI / 180)
                // theta = (lon + 180) * (Math.PI / 180)
                // x = -(r * Math.sin(phi) * Math.cos(theta))
                // z = (r * Math.sin(phi) * Math.sin(theta))
                // y = (r * Math.cos(phi))
                
                // ä½¿ç”¨ geo-three æä¾›çš„å·¥å…·æ›´å®‰å…¨ï¼Œä½†è¿™é‡Œæ‰‹åŠ¨è®¾ç½®ç›¸æœºä½ç½®
                // å®é™…ä¸Š geo-three çš„çƒä½“åŠå¾„éå¸¸å¤§ï¼Œæˆ‘ä»¬éœ€è¦è°ƒæ•´ç›¸æœºå‚æ•°
                
                // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å…ˆç”¨ PLANAR æ¨¡å¼è°ƒè¯•ï¼Œå› ä¸º SPHERICAL éœ€è¦å¤„ç†å·¨å¤§çš„åæ ‡å€¼
                // å›é€€åˆ° PLANAR ä½†ä¿®å¤åæ ‡é€»è¾‘
                
                /* PLANAR æ¨¡å¼ä¿®å¤å°è¯• */
                // this.map = new GEOTHREE.MapView(GEOTHREE.MapView.PLANAR, provider);
                // this.scene.add(this.map);
                // const hk_mercator = this.map.getProjection().project(22.3193, 114.1694); 
                // this.map.position.set(-hk_mercator[0], 0, -hk_mercator[1]); // ç§»åŠ¨åœ°å›¾ä½¿é¦™æ¸¯åœ¨åŸç‚¹
                
                /* å†æ¬¡å°è¯• SPHERICAL æ¨¡å¼ï¼Œé…åˆæ­£ç¡®çš„ç›¸æœºå®šä½ */
                // SPHERICAL æ¨¡å¼ä¸‹ï¼Œåœ°çƒåŠå¾„çº¦ä¸º 6,378,137 å•ä½
                // æˆ‘ä»¬éœ€è¦æŠŠç›¸æœºæ”¾åˆ°åœ°çƒè¡¨é¢ä¸Šæ–¹
                
                // è®©æˆ‘ä»¬ä½¿ç”¨ geo-three ç¤ºä¾‹ä¸­çš„æ ‡å‡†åšæ³•
                // ç›´æ¥ä½¿ç”¨ SPHERICAL æ¨¡å¼ï¼Œå¹¶æŠŠ Controls çš„ target è®¾ä¸ºé¦™æ¸¯
                
                this.scene.add(new THREE.AmbientLight(0xffffff, 1.2));
                this.scene.add(new THREE.DirectionalLight(0xffffff, 0.8));

                this.markerGroup = new THREE.Group();
                this.scene.add(this.markerGroup);
                
                // è®¡ç®—é¦™æ¸¯åœ¨çƒé¢ä¸Šçš„ä½ç½®
                // datumsToSpherical è¿”å›çš„æ˜¯ {x, y, z} å—ï¼Ÿ
                // geo-three çš„ datumsToSpherical(lat, lon) è¿”å› {x, y, z} å¯¹åº”åŠå¾„ R
                const R = GEOTHREE.UnitsUtils.EARTH_RADIUS;
                const hkPos = GEOTHREE.UnitsUtils.datumsToSpherical(22.3193, 114.1694);
                
                // ç›¸æœºä½ç½®ï¼šé¦™æ¸¯ä½ç½® + æ³•å‘é‡ * é«˜åº¦
                const normal = new THREE.Vector3(hkPos.x, hkPos.y, hkPos.z).normalize();
                const camDist = 20000; // 20km
                this.camera.position.copy(normal).multiplyScalar(R + camDist);
                this.camera.lookAt(hkPos.x, hkPos.y, hkPos.z);
                
                // æ§åˆ¶å™¨å›´ç»•é¦™æ¸¯æ—‹è½¬
                this.controls.target.set(hkPos.x, hkPos.y, hkPos.z);
                
                // è°ƒæ•´ Clipping Planesï¼Œå› ä¸ºåœ°çƒå¾ˆå¤§
                this.camera.near = 100;
                this.camera.far = 1e8;
                this.camera.updateProjectionMatrix();

                this.bindEvents();
                await this.loadLocations();
                this.startStatusPolling(); // å¯åŠ¨çŠ¶æ€è½®è¯¢
                this.animate();
            },

            bindEvents: function() {
                document.getElementById('upload-btn').onclick = () => UI.showUpload(true);
                document.getElementById('cancel-btn').onclick = () => UI.showUpload(false);
                document.getElementById('picker-btn').onclick = () => { UI.showUpload(false); UI.showToast(true); state.isPicking = true; };
                document.getElementById('submit-btn').onclick = () => this.handleUpload();
                document.getElementById('enter-btn').onclick = () => this.enterSplatMode();
                document.getElementById('close-splat').onclick = () => document.getElementById('splat-viewer').style.display = 'none';
                
                window.addEventListener('click', (e) => this.onClick(e));
                window.addEventListener('resize', () => {
                    this.camera.aspect = window.innerWidth / window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                });
            },

            loadLocations: async function() {
                try {
                    const res = await fetch(`https://huggingface.co/datasets/${REPO_ID}/resolve/main/locations.json?t=${Date.now()}`);
                    const newLocations = await res.json();
                    const hadChanges = JSON.stringify(state.locations) !== JSON.stringify(newLocations);
                    state.locations = newLocations;
                    
                    this.markerGroup.clear();
                    state.locations.forEach(loc => {
                        // åœ¨ SPHERICAL æ¨¡å¼ä¸‹ï¼Œç›´æ¥è®¡ç®—çƒé¢åæ ‡
                        const c = GEOTHREE.UnitsUtils.datumsToSpherical(loc.lat, loc.lon);
                        const mesh = new THREE.Mesh(new THREE.SphereGeometry(150), new THREE.MeshBasicMaterial({ color: loc.status==='processing'?0xffcc00:0x00ff88 }));
                        
                        // ç¨å¾®æŠ¬é«˜ä¸€ç‚¹ç‚¹ï¼Œé¿å…ä¸åœ°è¡¨é‡å  (åœ°çƒåŠå¾„çº¦ä¸º 6378137)
                        // å°†ä½ç½®å‘é‡æ²¿æ³•çº¿æ–¹å‘å»¶ä¼¸ 200 ç±³
                        const normal = new THREE.Vector3(c.x, c.y, c.z).normalize();
                        const surfacePos = new THREE.Vector3(c.x, c.y, c.z);
                        mesh.position.copy(surfacePos).add(normal.multiplyScalar(200));
                        
                        mesh.userData = loc;
                        this.markerGroup.add(mesh);
                    });
                    
                    // å¦‚æœå½“å‰é€‰ä¸­çš„ä½ç½®çŠ¶æ€æ›´æ–°äº†ï¼Œåˆ·æ–°UI
                    if(state.currentLoc) {
                        const updated = state.locations.find(l => l.id === state.currentLoc.id);
                        if(updated) {
                            const statusChanged = state.currentLoc.status !== updated.status;
                            state.currentLoc = updated;
                            document.getElementById('loc-status').innerText = updated.status==='processing'?'âŒ› å¤„ç†ä¸­...':'âœ… å·²å°±ç»ª';
                            const enterBtn = document.getElementById('enter-btn');
                            if(updated.status === 'processing') {
                                enterBtn.style.display = 'none';
                            } else {
                                enterBtn.style.display = 'block';
                                // å¦‚æœçŠ¶æ€ä»å¤„ç†ä¸­å˜ä¸ºå°±ç»ªï¼Œæ˜¾ç¤ºæç¤º
                                if(statusChanged) {
                                    document.getElementById('info-bar').style.display = 'block';
                                }
                            }
                        }
                    }
                    
                    return hadChanges;
                } catch(e) {
                    console.warn('åŠ è½½ä½ç½®æ•°æ®å¤±è´¥:', e);
                    return false;
                }
            },

            // å¯åŠ¨çŠ¶æ€è½®è¯¢ï¼šæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡ä»»åŠ¡çŠ¶æ€æ›´æ–°
            startStatusPolling: function() {
                setInterval(async () => {
                    const hadChanges = await this.loadLocations();
                    // å¦‚æœæœ‰çŠ¶æ€å˜åŒ–ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€šçŸ¥é€»è¾‘
                }, 5000); // æ¯5ç§’è½®è¯¢ä¸€æ¬¡
            },

            onClick: function(e) {
                if(e.target.closest('.pointer-auto')) return;
                const ray = new THREE.Raycaster();
                const m = new THREE.Vector2((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
                ray.setFromCamera(m, this.camera);

                // åæ ‡æ‹¾å–ï¼šç‚¹å‡»åœ°å›¾å¹³é¢è‡ªåŠ¨è·å–ç»çº¬åº¦ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥
                if(state.isPicking) {
                    const hits = ray.intersectObjects(this.map.children, true);
                    if(hits.length > 0) {
                        const p = hits[0].point;
                        // SPHERICAL æ¨¡å¼ä¸‹ï¼Œp æ˜¯çƒé¢ä¸Šçš„ç‚¹
                        // datumsToSpherical æ˜¯ lat/lon -> x/y/z
                        // sphericalToDatums æ˜¯ x/y/z -> lat/lon (ä½† geo-three æ–‡æ¡£ä¸ä¸€å®šæœ‰è¿™ä¸ªï¼Œéœ€ç¡®è®¤)
                        // é€šå¸¸ geo-three æä¾›äº† projection.unproject æˆ–è€… UnitsUtils.sphericalToDatums
                        
                        // å‡è®¾ UnitsUtils.sphericalToDatums å­˜åœ¨ä¸”æ¥å— x, y (projection åçš„) æˆ–è€…æˆ‘ä»¬ç›´æ¥ç”¨æ•°å­¦å…¬å¼
                        // å®é™…ä¸Š geo-three çš„ sphericalToDatums æ¥å— x, y (å¦‚æœæ˜¯ PLANAR)
                        
                        // åœ¨ SPHERICAL æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ projection çš„ inverse
                        // ä½†æœ€ç®€å•çš„æ˜¯ç›´æ¥ç”¨ä¸‰è§’å‡½æ•°åç®—
                        const r = Math.sqrt(p.x*p.x + p.y*p.y + p.z*p.z);
                        // phi: 0~PI (Yè½´å‘ä¸‹?), theta: 0~2PI
                        // geo-three çš„ Y è½´æ˜¯ä¸Šï¼ŒZ è½´æ˜¯å‰
                        // é€šå¸¸: y = r * sin(lat), x = r * cos(lat) * sin(lon), z = r * cos(lat) * cos(lon)
                        // è®©æˆ‘ä»¬ç›´æ¥è°ƒç”¨ geo-three çš„å·¥å…·ï¼Œå¦‚æœå­˜åœ¨
                        
                        let geo;
                        // å°è¯•ä½¿ç”¨ geo-three æä¾›çš„åç®—æ–¹æ³•
                        // æ³¨æ„ï¼šgeo-three çš„ map å¯¹è±¡é€šå¸¸æœ‰ providers å’Œ projection
                        // æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ map.provider.projection.unproject(point) ? ä¸ä¸€å®šæœ‰
                        
                        // ä½¿ç”¨é€šç”¨çƒåæ ‡å…¬å¼åç®—
                        // lat = asin(y / r)
                        // lon = atan2(x, z) ? éœ€è¦çœ‹ geo-three çš„å…·ä½“è½´å‘
                        // æ ¹æ® datumsToSpherical:
                        // x = - r * cos(lat) * sin(lon)
                        // y = r * sin(lat)
                        // z = r * cos(lat) * cos(lon)
                        // (è¿™æ˜¯çŒœæµ‹ï¼Œéœ€å®æµ‹ï¼Œæˆ–è€…ç›´æ¥ç”¨ geo-three çš„ projection)
                        
                        // æ›´å®‰å…¨çš„æ–¹å¼ï¼šåˆ©ç”¨ geo-three çš„ projection
                        // map.projection åº”è¯¥æœ‰ unproject æ–¹æ³•
                        // å®é™…ä¸Š geo-three 0.0.11 çš„ MapView æœ‰ projection å±æ€§
                        // ä½†åœ¨ SPHERICAL æ¨¡å¼ä¸‹ï¼Œtile æ˜¯è´´åœ¨çƒä¸Šçš„ã€‚
                        
                        // è®©æˆ‘ä»¬å°è¯•ä½¿ç”¨ GEOTHREE.UnitsUtils.sphericalToDatums 
                        // å¦‚æœå®ƒæ˜¯è®¾è®¡ç»™ SPHERICAL æ¨¡å¼ç”¨çš„ï¼Œé‚£ä¹ˆå®ƒåº”è¯¥æ¥å— x, y, z
                        // ä½†æŸ¥çœ‹æºç ï¼ŒsphericalToDatums(x, y) é€šå¸¸æ˜¯æŒ‡å¢¨å¡æ‰˜åç®—
                        
                        // æš‚æ—¶ç”¨æ‰‹åŠ¨åç®—ä»£æ›¿ï¼Œå‡è®¾ geo-three éµå¾ªæ ‡å‡† Three.js åæ ‡ç³»
                        // Y up, Z forward
                        const lat = Math.asin(p.y / r) * 180 / Math.PI;
                        const lon = Math.atan2(-p.x, p.z) * 180 / Math.PI; // æ³¨æ„è¿™é‡Œå¯èƒ½æœ‰æ­£è´Ÿå·å·®å¼‚
                        
                        geo = { latitude: lat, longitude: lon };

                        state.selectedCoords = geo;
                        document.getElementById('lat-lon-display').value = `${geo.latitude.toFixed(5)}, ${geo.longitude.toFixed(5)}`;
                        state.isPicking = false; UI.showToast(false); UI.showUpload(true);
                    }
                } else {
                    const hits = ray.intersectObjects(this.markerGroup.children);
                    if(hits.length > 0) {
                        state.currentLoc = hits[0].object.userData;
                        document.getElementById('info-bar').style.display = 'block';
                        document.getElementById('loc-title').innerText = state.currentLoc.desc || 'é¦™æ¸¯è®°å¿†ç‚¹';
                        document.getElementById('loc-desc').innerText = state.currentLoc.desc || '';
                        document.getElementById('loc-status').innerText = state.currentLoc.status==='processing'?'âŒ› å¤„ç†ä¸­...':'âœ… å·²å°±ç»ª';
                        const enterBtn = document.getElementById('enter-btn');
                        enterBtn.style.display = state.currentLoc.status==='processing'?'none':'block';
                    } else { document.getElementById('info-bar').style.display='none'; }
                }
            },

            // ä»»åŠ¡å¼‚æ­¥å¤„ç†ï¼šä¸Šä¼ ç…§ç‰‡åˆ° Hugging Faceï¼Œæ ‡è®°çŠ¶æ€ä¸º"å¤„ç†ä¸­"
            // æœ¬åœ° GPU è„šæœ¬ä¼šç›‘å¬å¹¶æ‹‰å–æ–°ä»»åŠ¡è¿›è¡Œ 3DGS é‡å»º
            handleUpload: async function() {
                const token = document.getElementById('hf-token').value;
                const file = document.getElementById('photo').files[0];
                if(!token || !file || !state.selectedCoords) return alert("è¯·å®Œæ•´å¡«å†™ï¼");
                
                const ts = Date.now();
                const path = `inputs/${ts}_${file.name}`;
                state.locations.push({ id: ts, lat: state.selectedCoords.latitude, lon: state.selectedCoords.longitude, desc: document.getElementById('desc').value, photoPath: path, splatPath: "", status: "processing" });
                
                try {
                    await commit({ credentials: { accessToken: token }, repo: { type: "dataset", name: REPO_ID }, operations: [
                        { operation: "addOrUpdate", path: path, content: file },
                        { operation: "addOrUpdate", path: "locations.json", content: new Blob([JSON.stringify(state.locations, null, 2)], {type:"application/json"}) }
                    ], title: `Job ${ts}` });
                    location.reload();
                } catch(e) { alert("ä¸Šä¼ å¤±è´¥: " + e.message); }
            },

            // é«˜ç²¾ 3D é‡å»ºå±•ç¤ºï¼šè¿›å…¥ 3DGS æ¨¡å‹çš„æ²‰æµ¸å¼è§†å›¾
            // ä½¿ç”¨ @mkkellogg/gaussian-splats-3d åº“å®ç°å®æ—¶æ¸²æŸ“
            enterSplatMode: function() {
                if(!state.currentLoc || state.currentLoc.status === 'processing') return;
                document.getElementById('splat-viewer').style.display = 'block';
                const url = `https://huggingface.co/datasets/${REPO_ID}/resolve/main/${state.currentLoc.splatPath}`;
                if(!state.viewer) {
                    state.viewer = new GaussianSplats3D.Viewer({ 'cameraUp': [0,-1,-0.6], 'initialCameraPosition':[-1,-4,6], 'rootElement': document.getElementById('splat-viewer') });
                    state.viewer.init();
                }
                // .ply æ–‡ä»¶ä¸æ”¯æŒ streamViewï¼Œä»… .splat æ”¯æŒ
                const isSplat = url.toLowerCase().endsWith('.splat');
                state.viewer.addSplatScene(url, {'streamView': isSplat}).then(() => state.viewer.start());
            },

            animate: function() { 
                requestAnimationFrame(() => this.animate()); 
                this.controls.update(); 
                this.renderer.render(this.scene, this.camera); 
            }
        };
        App.init();
    </script>
</body>
</html>
